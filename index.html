<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Darkwing Duck - Let's Get Dangerous!</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  background: #0a0a1a;
  overflow: hidden;
  font-family: 'Segoe UI', Arial, sans-serif;
  cursor: crosshair;
}
canvas {
  display: block;
  margin: 0 auto;
}
#loading {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: #0a0a1a;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  z-index: 1000; color: #fff;
  font-size: 24px;
}
#loading .bar {
  width: 300px; height: 8px; background: #222;
  border-radius: 4px; margin-top: 20px; overflow: hidden;
}
#loading .fill {
  height: 100%; width: 0%; background: linear-gradient(90deg, #7b2ff7, #c471f5);
  border-radius: 4px; transition: width 0.3s;
}
</style>
</head>
<body>
<div id="loading">
  <div>ü¶Ü Loading... Let's Get Dangerous!</div>
  <div class="bar"><div class="fill" id="loadBar"></div></div>
</div>
<canvas id="game"></canvas>
<script>
// ============================================================
// DARKWING DUCK - LET'S GET DANGEROUS!
// A high-end side-scrolling platformer
// ============================================================

const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');

// ---------- CONSTANTS & CONFIG ----------
const GRAVITY = 0.55;
const TERMINAL_VEL = 12;
const TILE = 40;

// ---------- CANVAS SIZING ----------
function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resize();
window.addEventListener('resize', resize);

// ---------- INPUT ----------
const keys = {};
const mouse = { x: 0, y: 0, down: false, clicked: false };
window.addEventListener('keydown', e => { keys[e.code] = true; e.preventDefault(); });
window.addEventListener('keyup', e => { keys[e.code] = false; });
canvas.addEventListener('mousemove', e => { mouse.x = e.clientX; mouse.y = e.clientY; });
canvas.addEventListener('mousedown', e => { mouse.down = true; mouse.clicked = true; });
canvas.addEventListener('mouseup', e => { mouse.down = false; });
canvas.addEventListener('contextmenu', e => e.preventDefault());

// ---------- AUDIO SYSTEM (Web Audio API) ----------
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let audioCtx;
function ensureAudio() {
  if (!audioCtx) audioCtx = new AudioCtx();
}

function playSound(type, vol = 0.3) {
  ensureAudio();
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.connect(g); g.connect(audioCtx.destination);
  g.gain.value = vol;
  const now = audioCtx.currentTime;
  switch(type) {
    case 'shoot':
      o.type = 'sawtooth'; o.frequency.setValueAtTime(800, now);
      o.frequency.exponentialRampToValueAtTime(200, now + 0.1);
      g.gain.exponentialRampToValueAtTime(0.01, now + 0.12);
      o.start(now); o.stop(now + 0.12); break;
    case 'jump':
      o.type = 'sine'; o.frequency.setValueAtTime(300, now);
      o.frequency.exponentialRampToValueAtTime(600, now + 0.15);
      g.gain.exponentialRampToValueAtTime(0.01, now + 0.18);
      o.start(now); o.stop(now + 0.18); break;
    case 'hit':
      o.type = 'square'; o.frequency.setValueAtTime(150, now);
      o.frequency.exponentialRampToValueAtTime(50, now + 0.2);
      g.gain.exponentialRampToValueAtTime(0.01, now + 0.25);
      o.start(now); o.stop(now + 0.25); break;
    case 'explosion':
      const buf = audioCtx.createBuffer(1, audioCtx.sampleRate * 0.4, audioCtx.sampleRate);
      const d = buf.getChannelData(0);
      for (let i = 0; i < d.length; i++) d[i] = (Math.random() * 2 - 1) * (1 - i / d.length);
      const src = audioCtx.createBufferSource();
      src.buffer = buf; src.connect(g); g.gain.value = vol * 0.6;
      g.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
      src.start(now); return;
    case 'powerup':
      o.type = 'sine';
      o.frequency.setValueAtTime(400, now);
      o.frequency.setValueAtTime(500, now + 0.05);
      o.frequency.setValueAtTime(600, now + 0.1);
      o.frequency.setValueAtTime(800, now + 0.15);
      g.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
      o.start(now); o.stop(now + 0.3); break;
    case 'boss':
      o.type = 'sawtooth'; o.frequency.setValueAtTime(80, now);
      o.frequency.setValueAtTime(60, now + 0.3);
      o.frequency.setValueAtTime(100, now + 0.6);
      g.gain.exponentialRampToValueAtTime(0.01, now + 0.8);
      o.start(now); o.stop(now + 0.8); break;
    case 'death':
      o.type = 'sawtooth'; o.frequency.setValueAtTime(400, now);
      o.frequency.exponentialRampToValueAtTime(30, now + 0.8);
      g.gain.exponentialRampToValueAtTime(0.01, now + 1.0);
      o.start(now); o.stop(now + 1.0); break;
    case 'select':
      o.type = 'sine'; o.frequency.setValueAtTime(500, now);
      o.frequency.setValueAtTime(700, now + 0.05);
      g.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
      o.start(now); o.stop(now + 0.1); break;
    case 'bossDeath':
      o.type = 'square'; o.frequency.setValueAtTime(200, now);
      for (let i = 0; i < 8; i++) {
        o.frequency.setValueAtTime(200 + i * 50, now + i * 0.1);
      }
      g.gain.exponentialRampToValueAtTime(0.01, now + 1.2);
      o.start(now); o.stop(now + 1.2); break;
  }
}

// ---------- PARTICLE SYSTEM ----------
class Particle {
  constructor(x, y, vx, vy, color, life, size, type = 'circle') {
    this.x = x; this.y = y; this.vx = vx; this.vy = vy;
    this.color = color; this.life = this.maxLife = life;
    this.size = size; this.type = type;
  }
  update() {
    this.x += this.vx; this.y += this.vy;
    this.vy += 0.05;
    this.life--;
    return this.life > 0;
  }
  draw(ctx, camX, camY) {
    const a = this.life / this.maxLife;
    ctx.globalAlpha = a;
    ctx.fillStyle = this.color;
    if (this.type === 'circle') {
      ctx.beginPath();
      ctx.arc(this.x - camX, this.y - camY, this.size * a, 0, Math.PI * 2);
      ctx.fill();
    } else if (this.type === 'spark') {
      ctx.save();
      ctx.translate(this.x - camX, this.y - camY);
      ctx.rotate(Math.atan2(this.vy, this.vx));
      ctx.fillRect(-this.size, -1, this.size * 2, 2);
      ctx.restore();
    } else if (this.type === 'smoke') {
      ctx.beginPath();
      ctx.arc(this.x - camX, this.y - camY, this.size * (2 - a), 0, Math.PI * 2);
      ctx.fill();
    }
    ctx.globalAlpha = 1;
  }
}

const particles = [];
function spawnParticles(x, y, count, color, speed, life, size, type) {
  for (let i = 0; i < count; i++) {
    const angle = Math.random() * Math.PI * 2;
    const spd = Math.random() * speed;
    particles.push(new Particle(x, y, Math.cos(angle) * spd, Math.sin(angle) * spd - 1, color, life + Math.random() * life * 0.5, size + Math.random() * size * 0.5, type));
  }
}

// ---------- SCREEN SHAKE ----------
let shakeAmount = 0;
let shakeDecay = 0.9;
function shake(amount) { shakeAmount = Math.max(shakeAmount, amount); }

// ---------- GAME STATE ----------
const GameState = { TITLE: 0, PLAYING: 1, BOSS_INTRO: 2, UPGRADE: 3, GAME_OVER: 4, WIN: 5, LEVEL_INTRO: 6 };
let state = GameState.TITLE;
let stateTimer = 0;

// ---------- PLAYER STATS ----------
const playerStats = {
  maxHP: 100, damage: 15, speed: 4.5, cooldownMult: 1.0,
  level: 1, currentLevel: 0, lives: 3
};

// ---------- SPECIAL ABILITIES ----------
const abilities = [
  { name: 'Launchpad', desc: 'Crash Landing (AoE)', key: '1', cooldown: 600, timer: 0, icon: '‚úàÔ∏è',
    color: '#ff6644',
    use(p) {
      playSound('explosion');
      shake(15);
      spawnParticles(p.x, p.y + 20, 30, '#ff4400', 6, 30, 5, 'circle');
      spawnParticles(p.x, p.y + 20, 20, '#ffaa00', 4, 20, 3, 'spark');
      enemies.forEach(e => {
        const dx = e.x - p.x, dy = e.y - p.y;
        if (Math.sqrt(dx*dx+dy*dy) < 250) {
          e.hp -= 40 + playerStats.damage;
          e.hitTimer = 10;
          spawnParticles(e.x, e.y, 8, '#ff6600', 3, 15, 3, 'circle');
        }
      });
      if (boss && Math.abs(boss.x - p.x) < 300) {
        boss.hp -= 30 + playerStats.damage;
        boss.hitTimer = 10;
      }
    }
  },
  { name: 'Gosalyn', desc: 'Speed Boost', key: '2', cooldown: 480, timer: 0, icon: 'üõπ',
    color: '#44ff66',
    use(p) {
      playSound('powerup');
      p.speedBoost = 120;
      p.invincible = 60;
      spawnParticles(p.x, p.y, 15, '#44ff88', 4, 25, 4, 'spark');
    }
  },
  { name: 'Morgana', desc: 'Magic Blast', key: '3', cooldown: 900, timer: 0, icon: 'üîÆ',
    color: '#bb44ff',
    use(p) {
      playSound('explosion'); shake(10);
      // screen clear - damage all enemies
      spawnParticles(p.x, p.y, 40, '#aa00ff', 8, 40, 6, 'circle');
      spawnParticles(p.x, p.y, 20, '#ff00ff', 5, 30, 4, 'spark');
      enemies.forEach(e => { e.hp -= 60 + playerStats.damage * 2; e.hitTimer = 15; });
      if (boss) { boss.hp -= 50 + playerStats.damage; boss.hitTimer = 15; }
    }
  },
  { name: 'Gizmoduck', desc: 'Armor Shield', key: '4', cooldown: 720, timer: 0, icon: 'üõ°Ô∏è',
    color: '#4488ff',
    use(p) {
      playSound('powerup');
      p.shield = 180;
      spawnParticles(p.x, p.y, 20, '#4488ff', 3, 20, 5, 'circle');
    }
  }
];

// ---------- LEVEL DEFINITIONS ----------
const LEVELS = [
  {
    name: 'St. Canard Rooftops',
    subtitle: 'The city never sleeps...',
    bg: { sky: '#0c0c2e', stars: true, buildings: true, color1: '#1a1a3e', color2: '#12122e' },
    platformColor: '#3a3a5a',
    platformAccent: '#5a5a8a',
    bossName: 'Megavolt',
    bossColor: '#ffee44',
    bossHP: 300,
    length: 4800,
    enemyTypes: ['goon', 'drone'],
    hazards: ['electric'],
    platforms: [
      // ground
      { x: 0, y: 560, w: 600, h: 40 },
      { x: 200, y: 460, w: 120, h: 20 },
      { x: 400, y: 380, w: 150, h: 20 },
      { x: 600, y: 480, w: 200, h: 20 },
      { x: 650, y: 560, w: 400, h: 40 },
      { x: 850, y: 400, w: 100, h: 20 },
      { x: 1000, y: 320, w: 120, h: 20 },
      { x: 1100, y: 560, w: 300, h: 40 },
      { x: 1150, y: 440, w: 100, h: 20 },
      { x: 1300, y: 360, w: 80, h: 20 },
      { x: 1400, y: 560, w: 500, h: 40 },
      { x: 1500, y: 430, w: 150, h: 20 },
      { x: 1700, y: 350, w: 100, h: 20 },
      { x: 1850, y: 280, w: 120, h: 20 },
      { x: 1900, y: 560, w: 400, h: 40 },
      { x: 2050, y: 450, w: 100, h: 20 },
      { x: 2200, y: 380, w: 150, h: 20 },
      { x: 2300, y: 560, w: 500, h: 40 },
      { x: 2450, y: 460, w: 120, h: 20 },
      { x: 2600, y: 380, w: 100, h: 20 },
      { x: 2750, y: 300, w: 80, h: 20 },
      { x: 2800, y: 560, w: 400, h: 40 },
      { x: 2950, y: 440, w: 150, h: 20 },
      { x: 3100, y: 360, w: 100, h: 20 },
      { x: 3200, y: 560, w: 300, h: 40 },
      { x: 3350, y: 460, w: 120, h: 20 },
      { x: 3500, y: 560, w: 400, h: 40 },
      { x: 3600, y: 420, w: 150, h: 20 },
      { x: 3800, y: 340, w: 100, h: 20 },
      { x: 3900, y: 560, w: 400, h: 40 },
      // boss arena
      { x: 4100, y: 560, w: 700, h: 40 },
      { x: 4250, y: 420, w: 100, h: 20 },
      { x: 4500, y: 420, w: 100, h: 20 },
    ],
    enemies: [
      { type: 'goon', x: 350, y: 520 },
      { type: 'goon', x: 700, y: 440 },
      { type: 'drone', x: 900, y: 300 },
      { type: 'goon', x: 1200, y: 520 },
      { type: 'drone', x: 1400, y: 280 },
      { type: 'goon', x: 1600, y: 390 },
      { type: 'goon', x: 1950, y: 520 },
      { type: 'drone', x: 2100, y: 300 },
      { type: 'goon', x: 2400, y: 520 },
      { type: 'goon', x: 2500, y: 420 },
      { type: 'drone', x: 2700, y: 250 },
      { type: 'goon', x: 2900, y: 520 },
      { type: 'goon', x: 3100, y: 520 },
      { type: 'drone', x: 3300, y: 300 },
      { type: 'goon', x: 3550, y: 520 },
      { type: 'goon', x: 3700, y: 380 },
      { type: 'drone', x: 3950, y: 280 },
    ],
    bossX: 4500
  },
  {
    name: 'Quackerjack\'s Funhouse',
    subtitle: 'Playtime is over... or is it?',
    bg: { sky: '#2a0a2e', stars: false, buildings: false, color1: '#3a1a4e', color2: '#2a0a3e',
      custom: 'funhouse' },
    platformColor: '#cc4488',
    platformAccent: '#ff66aa',
    bossName: 'Quackerjack',
    bossColor: '#ff44aa',
    bossHP: 400,
    length: 5200,
    enemyTypes: ['toySoldier', 'jackbox'],
    platforms: [
      { x: 0, y: 560, w: 500, h: 40 },
      { x: 200, y: 440, w: 100, h: 20 },
      { x: 380, y: 360, w: 120, h: 20 },
      { x: 500, y: 480, w: 80, h: 20 },
      { x: 550, y: 560, w: 400, h: 40 },
      { x: 700, y: 400, w: 100, h: 20 },
      { x: 850, y: 320, w: 80, h: 20 },
      { x: 950, y: 560, w: 300, h: 40 },
      { x: 1000, y: 440, w: 120, h: 20 },
      { x: 1150, y: 360, w: 100, h: 20 },
      { x: 1250, y: 560, w: 400, h: 40 },
      { x: 1350, y: 450, w: 80, h: 20 },
      { x: 1480, y: 370, w: 100, h: 20 },
      { x: 1600, y: 290, w: 80, h: 20 },
      { x: 1650, y: 560, w: 300, h: 40 },
      { x: 1750, y: 440, w: 120, h: 20 },
      { x: 1900, y: 360, w: 100, h: 20 },
      { x: 1950, y: 560, w: 500, h: 40 },
      { x: 2100, y: 460, w: 80, h: 20 },
      { x: 2250, y: 380, w: 120, h: 20 },
      { x: 2400, y: 300, w: 80, h: 20 },
      { x: 2450, y: 560, w: 400, h: 40 },
      { x: 2550, y: 440, w: 100, h: 20 },
      { x: 2700, y: 360, w: 120, h: 20 },
      { x: 2850, y: 560, w: 300, h: 40 },
      { x: 2950, y: 460, w: 100, h: 20 },
      { x: 3100, y: 380, w: 80, h: 20 },
      { x: 3200, y: 560, w: 400, h: 40 },
      { x: 3350, y: 440, w: 120, h: 20 },
      { x: 3500, y: 360, w: 100, h: 20 },
      { x: 3600, y: 560, w: 400, h: 40 },
      { x: 3750, y: 450, w: 80, h: 20 },
      { x: 3900, y: 370, w: 120, h: 20 },
      { x: 4000, y: 560, w: 300, h: 40 },
      // boss arena
      { x: 4300, y: 560, w: 900, h: 40 },
      { x: 4500, y: 400, w: 100, h: 20 },
      { x: 4750, y: 400, w: 100, h: 20 },
      { x: 4625, y: 300, w: 80, h: 20 },
    ],
    enemies: [
      { type: 'toySoldier', x: 300, y: 520 },
      { type: 'jackbox', x: 550, y: 520 },
      { type: 'toySoldier', x: 750, y: 360 },
      { type: 'jackbox', x: 1000, y: 520 },
      { type: 'toySoldier', x: 1300, y: 520 },
      { type: 'jackbox', x: 1500, y: 520 },
      { type: 'toySoldier', x: 1700, y: 400 },
      { type: 'toySoldier', x: 2000, y: 520 },
      { type: 'jackbox', x: 2200, y: 520 },
      { type: 'toySoldier', x: 2500, y: 520 },
      { type: 'jackbox', x: 2750, y: 520 },
      { type: 'toySoldier', x: 2950, y: 420 },
      { type: 'jackbox', x: 3200, y: 520 },
      { type: 'toySoldier', x: 3400, y: 520 },
      { type: 'jackbox', x: 3650, y: 520 },
      { type: 'toySoldier', x: 3850, y: 330 },
      { type: 'toySoldier', x: 4050, y: 520 },
    ],
    bossX: 4750
  },
  {
    name: 'Bushroot\'s Greenhouse',
    subtitle: 'Nature fights back!',
    bg: { sky: '#0a2a0a', stars: false, buildings: false, color1: '#1a3a1a', color2: '#0a2a0a',
      custom: 'greenhouse' },
    platformColor: '#2a6a2a',
    platformAccent: '#4a9a4a',
    bossName: 'Bushroot',
    bossColor: '#44bb44',
    bossHP: 450,
    length: 5600,
    enemyTypes: ['vine', 'spore'],
    platforms: [
      { x: 0, y: 560, w: 500, h: 40 },
      { x: 250, y: 440, w: 100, h: 20 },
      { x: 420, y: 360, w: 120, h: 20 },
      { x: 500, y: 560, w: 300, h: 40 },
      { x: 600, y: 460, w: 80, h: 20 },
      { x: 750, y: 380, w: 100, h: 20 },
      { x: 800, y: 560, w: 400, h: 40 },
      { x: 900, y: 440, w: 120, h: 20 },
      { x: 1050, y: 350, w: 80, h: 20 },
      { x: 1200, y: 560, w: 300, h: 40 },
      { x: 1280, y: 450, w: 100, h: 20 },
      { x: 1400, y: 370, w: 120, h: 20 },
      { x: 1500, y: 560, w: 500, h: 40 },
      { x: 1600, y: 440, w: 80, h: 20 },
      { x: 1750, y: 360, w: 100, h: 20 },
      { x: 1880, y: 280, w: 80, h: 20 },
      { x: 2000, y: 560, w: 400, h: 40 },
      { x: 2100, y: 460, w: 120, h: 20 },
      { x: 2250, y: 380, w: 100, h: 20 },
      { x: 2400, y: 560, w: 300, h: 40 },
      { x: 2450, y: 440, w: 80, h: 20 },
      { x: 2580, y: 360, w: 120, h: 20 },
      { x: 2700, y: 560, w: 400, h: 40 },
      { x: 2800, y: 450, w: 100, h: 20 },
      { x: 2950, y: 370, w: 80, h: 20 },
      { x: 3050, y: 560, w: 300, h: 40 },
      { x: 3150, y: 440, w: 120, h: 20 },
      { x: 3300, y: 360, w: 100, h: 20 },
      { x: 3400, y: 560, w: 400, h: 40 },
      { x: 3550, y: 460, w: 80, h: 20 },
      { x: 3700, y: 380, w: 120, h: 20 },
      { x: 3800, y: 560, w: 300, h: 40 },
      { x: 3950, y: 440, w: 100, h: 20 },
      { x: 4100, y: 560, w: 400, h: 40 },
      // boss arena
      { x: 4500, y: 560, w: 1100, h: 40 },
      { x: 4700, y: 400, w: 100, h: 20 },
      { x: 4950, y: 400, w: 100, h: 20 },
      { x: 5200, y: 400, w: 100, h: 20 },
      { x: 4825, y: 280, w: 80, h: 20 },
      { x: 5075, y: 280, w: 80, h: 20 },
    ],
    enemies: [
      { type: 'vine', x: 300, y: 520 },
      { type: 'spore', x: 500, y: 300 },
      { type: 'vine', x: 700, y: 520 },
      { type: 'spore', x: 900, y: 320 },
      { type: 'vine', x: 1100, y: 520 },
      { type: 'vine', x: 1350, y: 520 },
      { type: 'spore', x: 1550, y: 300 },
      { type: 'vine', x: 1750, y: 520 },
      { type: 'vine', x: 1950, y: 520 },
      { type: 'spore', x: 2150, y: 320 },
      { type: 'vine', x: 2350, y: 520 },
      { type: 'vine', x: 2550, y: 520 },
      { type: 'spore', x: 2750, y: 300 },
      { type: 'vine', x: 2950, y: 520 },
      { type: 'vine', x: 3150, y: 520 },
      { type: 'spore', x: 3350, y: 320 },
      { type: 'vine', x: 3600, y: 520 },
      { type: 'vine', x: 3850, y: 520 },
      { type: 'spore', x: 4050, y: 300 },
    ],
    bossX: 5050
  },
  {
    name: 'Liquidator\'s Dam',
    subtitle: 'Feeling a bit... washed up?',
    bg: { sky: '#0a1a3a', stars: false, buildings: false, color1: '#1a2a5a', color2: '#0a1a4a',
      custom: 'water' },
    platformColor: '#3a5a8a',
    platformAccent: '#5a8abb',
    bossName: 'Liquidator',
    bossColor: '#44aaff',
    bossHP: 500,
    length: 5600,
    platforms: [
      { x: 0, y: 560, w: 400, h: 40 },
      { x: 200, y: 450, w: 100, h: 20 },
      { x: 380, y: 370, w: 80, h: 20 },
      { x: 450, y: 560, w: 300, h: 40 },
      { x: 550, y: 460, w: 100, h: 20 },
      { x: 700, y: 380, w: 120, h: 20 },
      { x: 800, y: 560, w: 400, h: 40 },
      { x: 950, y: 440, w: 80, h: 20 },
      { x: 1100, y: 360, w: 100, h: 20 },
      { x: 1200, y: 560, w: 300, h: 40 },
      { x: 1300, y: 460, w: 120, h: 20 },
      { x: 1450, y: 380, w: 80, h: 20 },
      { x: 1500, y: 560, w: 500, h: 40 },
      { x: 1650, y: 440, w: 100, h: 20 },
      { x: 1800, y: 360, w: 120, h: 20 },
      { x: 1950, y: 280, w: 80, h: 20 },
      { x: 2000, y: 560, w: 400, h: 40 },
      { x: 2150, y: 460, w: 100, h: 20 },
      { x: 2300, y: 380, w: 80, h: 20 },
      { x: 2400, y: 560, w: 300, h: 40 },
      { x: 2500, y: 440, w: 120, h: 20 },
      { x: 2650, y: 360, w: 100, h: 20 },
      { x: 2750, y: 560, w: 400, h: 40 },
      { x: 2900, y: 460, w: 80, h: 20 },
      { x: 3050, y: 380, w: 120, h: 20 },
      { x: 3150, y: 560, w: 300, h: 40 },
      { x: 3250, y: 440, w: 100, h: 20 },
      { x: 3400, y: 360, w: 80, h: 20 },
      { x: 3500, y: 560, w: 400, h: 40 },
      { x: 3650, y: 460, w: 120, h: 20 },
      { x: 3800, y: 380, w: 100, h: 20 },
      { x: 3900, y: 560, w: 300, h: 40 },
      { x: 4050, y: 440, w: 80, h: 20 },
      { x: 4200, y: 560, w: 300, h: 40 },
      // boss arena
      { x: 4500, y: 560, w: 1100, h: 40 },
      { x: 4700, y: 420, w: 100, h: 20 },
      { x: 4950, y: 350, w: 100, h: 20 },
      { x: 5200, y: 420, w: 100, h: 20 },
    ],
    enemies: [
      { type: 'goon', x: 300, y: 520 },
      { type: 'drone', x: 500, y: 300 },
      { type: 'goon', x: 750, y: 520 },
      { type: 'goon', x: 950, y: 520 },
      { type: 'drone', x: 1150, y: 280 },
      { type: 'goon', x: 1350, y: 520 },
      { type: 'goon', x: 1600, y: 520 },
      { type: 'drone', x: 1800, y: 300 },
      { type: 'goon', x: 2050, y: 520 },
      { type: 'goon', x: 2300, y: 520 },
      { type: 'drone', x: 2500, y: 280 },
      { type: 'goon', x: 2700, y: 520 },
      { type: 'goon', x: 2950, y: 520 },
      { type: 'drone', x: 3150, y: 300 },
      { type: 'goon', x: 3400, y: 520 },
      { type: 'goon', x: 3650, y: 520 },
      { type: 'drone', x: 3900, y: 280 },
      { type: 'goon', x: 4100, y: 520 },
    ],
    bossX: 5050
  },
  {
    name: 'Negaduck\'s Fortress',
    subtitle: 'The final showdown!',
    bg: { sky: '#1a0a0a', stars: false, buildings: false, color1: '#3a1a1a', color2: '#2a0a0a',
      custom: 'fortress' },
    platformColor: '#5a2a2a',
    platformAccent: '#8a4a4a',
    bossName: 'Negaduck',
    bossColor: '#ff2244',
    bossHP: 600,
    length: 6000,
    platforms: [
      { x: 0, y: 560, w: 400, h: 40 },
      { x: 180, y: 440, w: 100, h: 20 },
      { x: 350, y: 360, w: 80, h: 20 },
      { x: 400, y: 560, w: 300, h: 40 },
      { x: 500, y: 460, w: 120, h: 20 },
      { x: 650, y: 380, w: 100, h: 20 },
      { x: 700, y: 560, w: 400, h: 40 },
      { x: 850, y: 440, w: 80, h: 20 },
      { x: 1000, y: 360, w: 120, h: 20 },
      { x: 1100, y: 560, w: 300, h: 40 },
      { x: 1200, y: 460, w: 100, h: 20 },
      { x: 1350, y: 380, w: 80, h: 20 },
      { x: 1400, y: 560, w: 500, h: 40 },
      { x: 1550, y: 440, w: 120, h: 20 },
      { x: 1700, y: 360, w: 100, h: 20 },
      { x: 1850, y: 280, w: 80, h: 20 },
      { x: 1900, y: 560, w: 400, h: 40 },
      { x: 2050, y: 460, w: 100, h: 20 },
      { x: 2200, y: 380, w: 120, h: 20 },
      { x: 2300, y: 560, w: 300, h: 40 },
      { x: 2400, y: 440, w: 80, h: 20 },
      { x: 2550, y: 360, w: 100, h: 20 },
      { x: 2600, y: 560, w: 400, h: 40 },
      { x: 2750, y: 460, w: 120, h: 20 },
      { x: 2900, y: 380, w: 80, h: 20 },
      { x: 3000, y: 560, w: 300, h: 40 },
      { x: 3100, y: 440, w: 100, h: 20 },
      { x: 3250, y: 360, w: 120, h: 20 },
      { x: 3300, y: 560, w: 400, h: 40 },
      { x: 3500, y: 460, w: 80, h: 20 },
      { x: 3650, y: 380, w: 100, h: 20 },
      { x: 3700, y: 560, w: 300, h: 40 },
      { x: 3850, y: 440, w: 120, h: 20 },
      { x: 4000, y: 560, w: 400, h: 40 },
      { x: 4150, y: 460, w: 100, h: 20 },
      { x: 4300, y: 380, w: 80, h: 20 },
      { x: 4400, y: 560, w: 300, h: 40 },
      // boss arena
      { x: 4800, y: 560, w: 1200, h: 40 },
      { x: 5000, y: 420, w: 100, h: 20 },
      { x: 5250, y: 350, w: 100, h: 20 },
      { x: 5500, y: 420, w: 100, h: 20 },
      { x: 5125, y: 260, w: 80, h: 20 },
      { x: 5375, y: 260, w: 80, h: 20 },
    ],
    enemies: [
      { type: 'goon', x: 250, y: 520 },
      { type: 'drone', x: 450, y: 280 },
      { type: 'toySoldier', x: 600, y: 520 },
      { type: 'goon', x: 800, y: 520 },
      { type: 'jackbox', x: 1000, y: 520 },
      { type: 'drone', x: 1200, y: 300 },
      { type: 'vine', x: 1400, y: 520 },
      { type: 'goon', x: 1600, y: 520 },
      { type: 'toySoldier', x: 1800, y: 520 },
      { type: 'drone', x: 2000, y: 280 },
      { type: 'goon', x: 2200, y: 520 },
      { type: 'jackbox', x: 2400, y: 520 },
      { type: 'vine', x: 2600, y: 520 },
      { type: 'goon', x: 2800, y: 520 },
      { type: 'drone', x: 3000, y: 300 },
      { type: 'toySoldier', x: 3200, y: 520 },
      { type: 'goon', x: 3500, y: 520 },
      { type: 'jackbox', x: 3700, y: 520 },
      { type: 'drone', x: 3900, y: 280 },
      { type: 'goon', x: 4100, y: 520 },
      { type: 'toySoldier', x: 4300, y: 520 },
    ],
    bossX: 5400
  }
];

// ---------- PLAYER ----------
let player = null;
function createPlayer() {
  return {
    x: 100, y: 400, vx: 0, vy: 0,
    w: 32, h: 48,
    hp: playerStats.maxHP,
    facing: 1,
    grounded: false,
    shooting: false, shootTimer: 0, shootCooldown: 0,
    animFrame: 0, animTimer: 0,
    invincible: 0, speedBoost: 0, shield: 0,
    hitTimer: 0, dead: false,
    jumpHeld: false, coyoteTime: 0,
    dashTimer: 0
  };
}

// ---------- BULLETS ----------
let bullets = [];
let enemyBullets = [];

// ---------- ENEMIES ----------
let enemies = [];
let boss = null;
let bossActive = false;
let bossIntroTimer = 0;

function createEnemy(def) {
  const base = { x: def.x, y: def.y, vx: 0, vy: 0, hitTimer: 0, animTimer: 0, facing: -1, active: true };
  switch(def.type) {
    case 'goon':
      return { ...base, type: 'goon', w: 28, h: 40, hp: 30, maxHP: 30, speed: 1.2, damage: 10, shootTimer: 120 + Math.random() * 60 };
    case 'drone':
      return { ...base, type: 'drone', w: 30, h: 24, hp: 20, maxHP: 20, speed: 1.5, damage: 8, floatOffset: Math.random() * Math.PI * 2, baseY: def.y };
    case 'toySoldier':
      return { ...base, type: 'toySoldier', w: 24, h: 36, hp: 35, maxHP: 35, speed: 1.8, damage: 12, jumpTimer: 60 + Math.random() * 60 };
    case 'jackbox':
      return { ...base, type: 'jackbox', w: 30, h: 30, hp: 25, maxHP: 25, speed: 0.5, damage: 15, popTimer: 0, popped: false };
    case 'vine':
      return { ...base, type: 'vine', w: 24, h: 50, hp: 40, maxHP: 40, speed: 0.8, damage: 12, whipTimer: 90 };
    case 'spore':
      return { ...base, type: 'spore', w: 20, h: 20, hp: 15, maxHP: 15, speed: 0.6, damage: 8, floatOffset: Math.random() * Math.PI * 2, baseY: def.y, sporeTimer: 120 };
    default:
      return { ...base, type: 'goon', w: 28, h: 40, hp: 30, maxHP: 30, speed: 1.2, damage: 10, shootTimer: 120 };
  }
}

// ---------- BOSS SYSTEM ----------
function createBoss(level) {
  const def = LEVELS[level];
  const b = {
    x: def.bossX, y: 480, w: 60, h: 70,
    vx: 0, vy: 0,
    hp: def.bossHP, maxHP: def.bossHP,
    name: def.bossName, color: def.bossColor,
    phase: 1, phaseTimer: 0,
    attackTimer: 60, attackType: 0,
    hitTimer: 0, facing: -1,
    grounded: false, dead: false,
    deathTimer: 0,
    level: level
  };
  return b;
}

function updateBoss() {
  if (!boss || boss.dead) return;
  
  boss.phaseTimer++;
  
  // Phase transitions
  const hpPct = boss.hp / boss.maxHP;
  if (hpPct < 0.3 && boss.phase < 3) { boss.phase = 3; playSound('boss'); shake(8); }
  else if (hpPct < 0.6 && boss.phase < 2) { boss.phase = 2; playSound('boss'); shake(5); }
  
  // Face player
  boss.facing = player.x < boss.x ? -1 : 1;
  
  // Gravity
  boss.vy += GRAVITY;
  if (boss.vy > TERMINAL_VEL) boss.vy = TERMINAL_VEL;
  
  // Boss AI by type
  boss.attackTimer--;
  
  const level = LEVELS[boss.level];
  const dist = Math.abs(player.x - boss.x);
  
  switch(boss.name) {
    case 'Megavolt':
      // Lightning attacks - shoots electric bolts
      if (boss.attackTimer <= 0) {
        if (boss.phase >= 2 && Math.random() < 0.3) {
          // Spread shot
          for (let i = -2; i <= 2; i++) {
            const angle = Math.atan2(player.y - boss.y, player.x - boss.x) + i * 0.2;
            enemyBullets.push({ x: boss.x, y: boss.y, vx: Math.cos(angle) * 5, vy: Math.sin(angle) * 5, damage: 12, color: '#ffee44', size: 5, life: 120 });
          }
        } else {
          const angle = Math.atan2(player.y - boss.y, player.x - boss.x);
          enemyBullets.push({ x: boss.x, y: boss.y, vx: Math.cos(angle) * 6, vy: Math.sin(angle) * 6, damage: 15, color: '#ffee44', size: 6, life: 120 });
        }
        spawnParticles(boss.x, boss.y, 5, '#ffee44', 3, 15, 3, 'spark');
        playSound('shoot');
        boss.attackTimer = boss.phase >= 3 ? 30 : boss.phase >= 2 ? 45 : 60;
      }
      // Movement - hop toward player
      if (boss.grounded && boss.phaseTimer % (boss.phase >= 3 ? 40 : 60) === 0) {
        boss.vy = -8;
        boss.vx = boss.facing * (3 + boss.phase);
      }
      break;
      
    case 'Quackerjack':
      // Bouncy unpredictable movement + toy bombs
      if (boss.attackTimer <= 0) {
        // Throw bouncing toy
        const angle = Math.atan2(player.y - boss.y, player.x - boss.x);
        enemyBullets.push({ x: boss.x, y: boss.y, vx: Math.cos(angle) * 4, vy: -5, damage: 15, color: '#ff44aa', size: 8, life: 180, bouncy: true });
        if (boss.phase >= 2) {
          enemyBullets.push({ x: boss.x, y: boss.y, vx: Math.cos(angle) * 3, vy: -7, damage: 12, color: '#ff88cc', size: 6, life: 180, bouncy: true });
        }
        playSound('shoot');
        boss.attackTimer = boss.phase >= 3 ? 25 : 40;
      }
      // Erratic jumping
      if (boss.grounded && Math.random() < 0.05 * boss.phase) {
        boss.vy = -10 - Math.random() * 4;
        boss.vx = (Math.random() - 0.5) * 8 * boss.phase;
      }
      break;
      
    case 'Bushroot':
      // Vine whip + seed projectiles
      if (boss.attackTimer <= 0) {
        if (dist < 150) {
          // Vine whip - melee area
          spawnParticles(boss.x + boss.facing * 60, boss.y, 10, '#44bb44', 4, 20, 4, 'circle');
          if (dist < 100) {
            damagePlayer(20);
          }
          playSound('hit');
        } else {
          // Seed projectiles
          const count = boss.phase >= 3 ? 5 : boss.phase >= 2 ? 3 : 1;
          for (let i = 0; i < count; i++) {
            const angle = Math.atan2(player.y - boss.y, player.x - boss.x) + (i - Math.floor(count/2)) * 0.3;
            enemyBullets.push({ x: boss.x, y: boss.y, vx: Math.cos(angle) * 4, vy: Math.sin(angle) * 4 - 2, damage: 10, color: '#66dd66', size: 5, life: 150 });
          }
          playSound('shoot');
        }
        boss.attackTimer = boss.phase >= 3 ? 35 : 50;
      }
      // Slow pursuit
      if (boss.grounded) {
        boss.vx = boss.facing * (1.5 + boss.phase * 0.5);
        if (dist < 80) boss.vx = -boss.facing * 3;
      }
      break;
      
    case 'Liquidator':
      // Water wave attacks + teleport
      if (boss.attackTimer <= 0) {
        if (boss.phase >= 2 && Math.random() < 0.3) {
          // Water wave - ground projectile
          for (let i = -1; i <= 1; i += 2) {
            enemyBullets.push({ x: boss.x, y: 540, vx: i * 5, vy: 0, damage: 18, color: '#44aaff', size: 10, life: 200, wave: true });
          }
          spawnParticles(boss.x, 540, 15, '#44aaff', 4, 20, 5, 'circle');
          playSound('explosion');
        } else {
          const angle = Math.atan2(player.y - boss.y, player.x - boss.x);
          for (let i = 0; i < 2 + boss.phase; i++) {
            enemyBullets.push({ x: boss.x, y: boss.y, vx: Math.cos(angle) * (4 + i * 0.5), vy: Math.sin(angle) * (4 + i * 0.5), damage: 12, color: '#44aaff', size: 5, life: 120 });
          }
          playSound('shoot');
        }
        boss.attackTimer = boss.phase >= 3 ? 30 : 45;
      }
      // Teleport occasionally
      if (boss.grounded && Math.random() < 0.01 * boss.phase) {
        spawnParticles(boss.x, boss.y, 15, '#44aaff', 5, 20, 6, 'smoke');
        boss.x = player.x + (Math.random() < 0.5 ? -200 : 200);
        spawnParticles(boss.x, boss.y, 15, '#44aaff', 5, 20, 6, 'smoke');
      }
      break;
      
    case 'Negaduck':
      // Everything - chainsaw rush + bombs + aggressive
      if (boss.attackTimer <= 0) {
        const atk = Math.floor(Math.random() * (2 + boss.phase));
        switch(atk) {
          case 0: // Chainsaw rush
            boss.vx = boss.facing * 10;
            boss.vy = -3;
            spawnParticles(boss.x, boss.y, 8, '#ff2244', 3, 15, 3, 'spark');
            playSound('hit');
            break;
          case 1: // Bomb throw
            enemyBullets.push({ x: boss.x, y: boss.y - 20, vx: boss.facing * 5, vy: -6, damage: 20, color: '#ff4444', size: 8, life: 120, bomb: true });
            playSound('shoot');
            break;
          case 2: // Spread shot
            for (let i = -3; i <= 3; i++) {
              const a = Math.atan2(player.y - boss.y, player.x - boss.x) + i * 0.15;
              enemyBullets.push({ x: boss.x, y: boss.y, vx: Math.cos(a) * 6, vy: Math.sin(a) * 6, damage: 10, color: '#ff2244', size: 4, life: 90 });
            }
            playSound('shoot');
            break;
          case 3: // Ground pound
            boss.vy = -12;
            setTimeout(() => { if(boss && !boss.dead) { shake(10); playSound('explosion'); 
              spawnParticles(boss.x, boss.y + 35, 20, '#ff4400', 5, 25, 5, 'circle'); 
              if (Math.abs(player.x - boss.x) < 150 && player.y > boss.y) damagePlayer(25);
            }}, 500);
            break;
        }
        boss.attackTimer = boss.phase >= 3 ? 20 : boss.phase >= 2 ? 35 : 50;
      }
      // Aggressive pursuit
      if (boss.grounded) {
        boss.vx = boss.facing * (2 + boss.phase);
        if (boss.phaseTimer % 30 === 0 && Math.random() < 0.3) boss.vy = -9;
      }
      break;
  }
  
  // Apply physics
  boss.x += boss.vx;
  boss.y += boss.vy;
  boss.vx *= 0.9;
  
  // Platform collision for boss
  boss.grounded = false;
  const lvl = LEVELS[playerStats.currentLevel];
  for (const p of lvl.platforms) {
    if (boss.x + 30 > p.x && boss.x - 30 < p.x + p.w &&
        boss.y + 35 > p.y && boss.y + 35 < p.y + p.h + 10 && boss.vy >= 0) {
      boss.y = p.y - 35;
      boss.vy = 0;
      boss.grounded = true;
    }
  }
  
  // Keep in arena
  const arenaLeft = lvl.bossX - 350;
  const arenaRight = lvl.bossX + 350;
  if (boss.x < arenaLeft) { boss.x = arenaLeft; boss.vx = Math.abs(boss.vx); }
  if (boss.x > arenaRight) { boss.x = arenaRight; boss.vx = -Math.abs(boss.vx); }
  
  // Hit timer
  if (boss.hitTimer > 0) boss.hitTimer--;
  
  // Check death
  if (boss.hp <= 0 && !boss.dead) {
    boss.dead = true;
    boss.deathTimer = 120;
    playSound('bossDeath');
    shake(20);
    spawnParticles(boss.x, boss.y, 40, boss.color, 8, 50, 8, 'circle');
    spawnParticles(boss.x, boss.y, 25, '#ffffff', 6, 40, 5, 'spark');
  }
  
  if (boss.dead) {
    boss.deathTimer--;
    if (boss.deathTimer % 8 === 0) {
      const ox = (Math.random() - 0.5) * 60;
      const oy = (Math.random() - 0.5) * 60;
      spawnParticles(boss.x + ox, boss.y + oy, 5, boss.color, 4, 20, 4, 'circle');
      playSound('explosion');
      shake(5);
    }
    if (boss.deathTimer <= 0) {
      // Level complete!
      if (playerStats.currentLevel >= LEVELS.length - 1) {
        state = GameState.WIN;
      } else {
        state = GameState.UPGRADE;
      }
      stateTimer = 0;
    }
  }
  
  // Boss contact damage
  if (!boss.dead && !player.dead) {
    if (Math.abs(player.x - boss.x) < 35 && Math.abs(player.y - boss.y) < 45) {
      damagePlayer(boss.name === 'Negaduck' ? 20 : 15);
    }
  }
}

// ---------- DAMAGE PLAYER ----------
function damagePlayer(amount) {
  if (player.invincible > 0 || player.dead) return;
  if (player.shield > 0) {
    player.shield -= 30;
    if (player.shield < 0) player.shield = 0;
    spawnParticles(player.x, player.y, 8, '#4488ff', 3, 15, 3, 'spark');
    playSound('hit');
    return;
  }
  player.hp -= amount;
  player.hitTimer = 20;
  player.invincible = 45;
  shake(6);
  playSound('hit');
  spawnParticles(player.x, player.y, 10, '#ff4444', 3, 20, 3, 'circle');
  if (player.hp <= 0) {
    player.dead = true;
    player.hp = 0;
    playSound('death');
    spawnParticles(player.x, player.y, 30, '#ff4444', 5, 40, 5, 'circle');
    spawnParticles(player.x, player.y, 15, '#ffffff', 4, 30, 3, 'spark');
    setTimeout(() => {
      playerStats.lives--;
      if (playerStats.lives <= 0) {
        state = GameState.GAME_OVER;
      } else {
        loadLevel(playerStats.currentLevel);
      }
    }, 1500);
  }
}

// ---------- LOAD LEVEL ----------
let currentPlatforms = [];
function loadLevel(idx) {
  playerStats.currentLevel = idx;
  const lvl = LEVELS[idx];
  player = createPlayer();
  player.hp = playerStats.maxHP;
  bullets = [];
  enemyBullets = [];
  particles.length = 0;
  enemies = lvl.enemies.map(e => createEnemy(e));
  currentPlatforms = lvl.platforms;
  boss = null;
  bossActive = false;
  state = GameState.LEVEL_INTRO;
  stateTimer = 0;
}

// ---------- DRAWING HELPERS ----------
function drawDarkwing(x, y, facing, frame, shooting, hit, shield, invincible) {
  ctx.save();
  ctx.translate(x, y);
  if (facing < 0) ctx.scale(-1, 1);
  
  const flash = hit > 0 && hit % 4 < 2;
  const invis = invincible > 0 && invincible % 6 < 3;
  if (invis) ctx.globalAlpha = 0.5;
  
  // Shadow
  ctx.fillStyle = 'rgba(0,0,0,0.3)';
  ctx.beginPath();
  ctx.ellipse(0, 24, 16, 5, 0, 0, Math.PI * 2);
  ctx.fill();
  
  // Cape
  ctx.fillStyle = flash ? '#ffffff' : '#6a2fa0';
  ctx.beginPath();
  const capeWave = Math.sin(frame * 0.3) * 3;
  ctx.moveTo(-8, -10);
  ctx.quadraticCurveTo(-22, 5 + capeWave, -18, 24);
  ctx.lineTo(-5, 20);
  ctx.lineTo(-5, -5);
  ctx.fill();
  
  // Body
  ctx.fillStyle = flash ? '#ffffff' : '#7b2ff7';
  ctx.fillRect(-10, -5, 20, 25);
  
  // Legs with walk animation
  const legAnim = Math.sin(frame * 0.4) * 6;
  ctx.fillStyle = flash ? '#ffffff' : '#5a1fb0';
  ctx.fillRect(-8, 18, 6, 8 + (frame % 20 < 10 ? legAnim : -legAnim));
  ctx.fillRect(2, 18, 6, 8 + (frame % 20 < 10 ? -legAnim : legAnim));
  
  // Head
  ctx.fillStyle = flash ? '#ffffff' : '#f5deb3';
  ctx.beginPath();
  ctx.ellipse(0, -14, 12, 10, 0, 0, Math.PI * 2);
  ctx.fill();
  
  // Hat
  ctx.fillStyle = flash ? '#ffffff' : '#7b2ff7';
  ctx.beginPath();
  ctx.ellipse(0, -22, 14, 5, 0, 0, Math.PI * 2);
  ctx.fill();
  ctx.fillRect(-6, -30, 12, 10);
  
  // Mask
  ctx.fillStyle = flash ? '#ffffff' : '#7b2ff7';
  ctx.fillRect(-12, -18, 24, 6);
  
  // Eyes
  ctx.fillStyle = '#ffffff';
  ctx.beginPath();
  ctx.ellipse(-4, -14, 3, 3, 0, 0, Math.PI * 2);
  ctx.ellipse(4, -14, 3, 3, 0, 0, Math.PI * 2);
  ctx.fill();
  ctx.fillStyle = '#000000';
  ctx.beginPath();
  ctx.ellipse(-3, -14, 1.5, 1.5, 0, 0, Math.PI * 2);
  ctx.ellipse(5, -14, 1.5, 1.5, 0, 0, Math.PI * 2);
  ctx.fill();
  
  // Bill
  ctx.fillStyle = flash ? '#ffffff' : '#f4a460';
  ctx.beginPath();
  ctx.ellipse(2, -9, 8, 4, 0, 0, Math.PI * 2);
  ctx.fill();
  
  // Gas gun
  if (shooting) {
    ctx.fillStyle = '#888';
    ctx.fillRect(10, -4, 18, 5);
    ctx.fillStyle = '#aaa';
    ctx.fillRect(25, -6, 4, 9);
    // Muzzle flash
    ctx.fillStyle = '#ff8844';
    ctx.beginPath();
    ctx.arc(30, -1, 6 + Math.random() * 4, 0, Math.PI * 2);
    ctx.fill();
  } else {
    ctx.fillStyle = '#888';
    ctx.fillRect(8, -2, 14, 4);
  }
  
  // Shield effect
  if (shield > 0) {
    ctx.strokeStyle = `rgba(68,136,255,${0.3 + Math.sin(Date.now() * 0.01) * 0.2})`;
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.ellipse(0, 0, 25, 30, 0, 0, Math.PI * 2);
    ctx.stroke();
  }
  
  ctx.globalAlpha = 1;
  ctx.restore();
}

function drawEnemy(e, camX, camY) {
  if (!e.active) return;
  const x = e.x - camX, y = e.y - camY;
  const flash = e.hitTimer > 0 && e.hitTimer % 4 < 2;
  
  ctx.save();
  ctx.translate(x, y);
  if (e.facing < 0) ctx.scale(-1, 1);
  
  switch(e.type) {
    case 'goon':
      // F.O.W.L. goon - suited thug
      ctx.fillStyle = flash ? '#fff' : '#444';
      ctx.fillRect(-12, -18, 24, 36);
      ctx.fillStyle = flash ? '#fff' : '#666';
      ctx.fillRect(-14, -18, 28, 10);
      ctx.fillStyle = flash ? '#fff' : '#f5deb3';
      ctx.beginPath(); ctx.arc(0, -22, 8, 0, Math.PI * 2); ctx.fill();
      ctx.fillStyle = flash ? '#fff' : '#333';
      ctx.fillRect(-10, -30, 20, 6);
      // Gun
      ctx.fillStyle = '#777';
      ctx.fillRect(10, -5, 10, 3);
      break;
    case 'drone':
      // Flying drone
      ctx.fillStyle = flash ? '#fff' : '#888';
      ctx.beginPath(); ctx.ellipse(0, 0, 15, 10, 0, 0, Math.PI * 2); ctx.fill();
      ctx.fillStyle = flash ? '#fff' : '#ff4444';
      ctx.beginPath(); ctx.arc(6, -2, 3, 0, Math.PI * 2); ctx.fill();
      // Propeller
      const propAngle = Date.now() * 0.03;
      ctx.strokeStyle = '#aaa';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(-12 + Math.cos(propAngle) * 10, -12);
      ctx.lineTo(-12 - Math.cos(propAngle) * 10, -12);
      ctx.stroke();
      break;
    case 'toySoldier':
      // Wind-up toy soldier
      ctx.fillStyle = flash ? '#fff' : '#ee3344';
      ctx.fillRect(-10, -16, 20, 32);
      ctx.fillStyle = flash ? '#fff' : '#ffcc00';
      ctx.fillRect(-12, -16, 24, 8);
      ctx.fillStyle = flash ? '#fff' : '#f5deb3';
      ctx.beginPath(); ctx.arc(0, -20, 7, 0, Math.PI * 2); ctx.fill();
      // Wind-up key
      ctx.fillStyle = '#cc9900';
      ctx.fillRect(-18, -5, 8, 3);
      ctx.beginPath(); ctx.arc(-20, -3, 4, 0, Math.PI * 2); ctx.stroke();
      break;
    case 'jackbox':
      // Jack-in-the-box
      ctx.fillStyle = flash ? '#fff' : '#ff66aa';
      ctx.fillRect(-14, -5, 28, 20);
      ctx.fillStyle = flash ? '#fff' : '#ffaa00';
      ctx.fillRect(-16, -5, 32, 5);
      if (e.popped) {
        ctx.fillStyle = flash ? '#fff' : '#ff44aa';
        ctx.beginPath(); ctx.arc(0, -25, 12, 0, Math.PI * 2); ctx.fill();
        ctx.fillStyle = '#000';
        ctx.beginPath(); ctx.arc(-4, -27, 2, 0, Math.PI * 2); ctx.fill();
        ctx.beginPath(); ctx.arc(4, -27, 2, 0, Math.PI * 2); ctx.fill();
        // Spring
        ctx.strokeStyle = '#888';
        ctx.lineWidth = 2;
        for (let i = 0; i < 4; i++) {
          ctx.beginPath();
          ctx.moveTo(-5 + (i % 2) * 10, -5 - i * 5);
          ctx.lineTo(5 - (i % 2) * 10, -10 - i * 5);
          ctx.stroke();
        }
      }
      break;
    case 'vine':
      // Animated vine creature
      ctx.fillStyle = flash ? '#fff' : '#338833';
      // Trunk
      const sway = Math.sin(Date.now() * 0.003 + e.x) * 3;
      ctx.beginPath();
      ctx.moveTo(-6, 25); ctx.lineTo(6, 25);
      ctx.quadraticCurveTo(8 + sway, 0, 4 + sway, -20);
      ctx.quadraticCurveTo(0 + sway, -28, -4 + sway, -20);
      ctx.quadraticCurveTo(-8 + sway, 0, -6, 25);
      ctx.fill();
      // Eyes
      ctx.fillStyle = flash ? '#fff' : '#ff4444';
      ctx.beginPath();
      ctx.arc(-3 + sway, -15, 3, 0, Math.PI * 2);
      ctx.arc(3 + sway, -15, 3, 0, Math.PI * 2);
      ctx.fill();
      // Tendrils
      ctx.strokeStyle = flash ? '#fff' : '#448844';
      ctx.lineWidth = 3;
      for (let i = -1; i <= 1; i += 2) {
        ctx.beginPath();
        ctx.moveTo(i * 6, 0);
        ctx.quadraticCurveTo(i * 20 + Math.sin(Date.now() * 0.005) * 5, -5, i * 15, 10);
        ctx.stroke();
      }
      break;
    case 'spore':
      // Floating spore
      ctx.fillStyle = flash ? '#fff' : '#88cc44';
      ctx.globalAlpha = 0.8;
      ctx.beginPath(); ctx.arc(0, 0, 10, 0, Math.PI * 2); ctx.fill();
      ctx.globalAlpha = 0.4;
      ctx.beginPath(); ctx.arc(0, 0, 14, 0, Math.PI * 2); ctx.fill();
      ctx.globalAlpha = 1;
      ctx.fillStyle = '#446622';
      ctx.beginPath(); ctx.arc(-3, -2, 2, 0, Math.PI * 2); ctx.fill();
      ctx.beginPath(); ctx.arc(3, -2, 2, 0, Math.PI * 2); ctx.fill();
      break;
  }
  
  ctx.restore();
  
  // HP bar
  if (e.hp < e.maxHP) {
    const bw = 30;
    ctx.fillStyle = '#333';
    ctx.fillRect(x - bw/2, y - e.h/2 - 12, bw, 4);
    ctx.fillStyle = '#ff4444';
    ctx.fillRect(x - bw/2, y - e.h/2 - 12, bw * (e.hp / e.maxHP), 4);
  }
}

function drawBoss(camX, camY) {
  if (!boss) return;
  const x = boss.x - camX, y = boss.y - camY;
  const flash = boss.hitTimer > 0 && boss.hitTimer % 4 < 2;
  
  ctx.save();
  ctx.translate(x, y);
  if (boss.facing < 0) ctx.scale(-1, 1);
  
  // Glow effect
  if (boss.phase >= 2) {
    ctx.shadowColor = boss.color;
    ctx.shadowBlur = 15 + boss.phase * 5;
  }
  
  const bc = flash ? '#ffffff' : boss.color;
  
  switch(boss.name) {
    case 'Megavolt':
      // Body
      ctx.fillStyle = flash ? '#fff' : '#ffdd00';
      ctx.fillRect(-20, -15, 40, 40);
      // Battery pack
      ctx.fillStyle = flash ? '#fff' : '#888';
      ctx.fillRect(-25, -10, 10, 30);
      ctx.fillRect(15, -10, 10, 30);
      // Head - plug shaped
      ctx.fillStyle = flash ? '#fff' : '#f5deb3';
      ctx.beginPath(); ctx.arc(0, -22, 14, 0, Math.PI * 2); ctx.fill();
      // Goggles
      ctx.fillStyle = flash ? '#fff' : '#ff4444';
      ctx.beginPath(); ctx.ellipse(-6, -24, 6, 5, 0, 0, Math.PI * 2); ctx.fill();
      ctx.beginPath(); ctx.ellipse(6, -24, 6, 5, 0, 0, Math.PI * 2); ctx.fill();
      ctx.strokeStyle = '#444'; ctx.lineWidth = 1;
      ctx.stroke();
      // Electric arcs
      if (!boss.dead) {
        ctx.strokeStyle = '#ffff00';
        ctx.lineWidth = 2;
        for (let i = 0; i < 3; i++) {
          ctx.beginPath();
          let px = -20 + Math.random() * 40, py = -30 + Math.random() * 20;
          ctx.moveTo(px, py);
          for (let j = 0; j < 3; j++) {
            px += (Math.random() - 0.5) * 15;
            py += Math.random() * 10;
            ctx.lineTo(px, py);
          }
          ctx.stroke();
        }
      }
      // Legs
      ctx.fillStyle = flash ? '#fff' : '#ddbb00';
      ctx.fillRect(-12, 22, 8, 14);
      ctx.fillRect(4, 22, 8, 14);
      break;
      
    case 'Quackerjack':
      // Jester outfit
      ctx.fillStyle = flash ? '#fff' : '#ff44aa';
      ctx.fillRect(-18, -10, 36, 38);
      // Polka dots
      if (!flash) {
        ctx.fillStyle = '#ffaa00';
        for (let i = 0; i < 5; i++) {
          ctx.beginPath();
          ctx.arc(-10 + i * 7, -2 + (i % 2) * 12, 3, 0, Math.PI * 2);
          ctx.fill();
        }
      }
      // Head
      ctx.fillStyle = flash ? '#fff' : '#f5deb3';
      ctx.beginPath(); ctx.arc(0, -18, 14, 0, Math.PI * 2); ctx.fill();
      // Jester hat
      ctx.fillStyle = flash ? '#fff' : '#ff44aa';
      ctx.beginPath();
      ctx.moveTo(-14, -28); ctx.quadraticCurveTo(-20, -50, -10, -45);
      ctx.lineTo(0, -30);
      ctx.fill();
      ctx.fillStyle = flash ? '#fff' : '#ffaa00';
      ctx.beginPath();
      ctx.moveTo(0, -30); ctx.quadraticCurveTo(20, -50, 10, -45);
      ctx.lineTo(14, -28);
      ctx.fill();
      // Bells
      ctx.fillStyle = '#ffee00';
      ctx.beginPath(); ctx.arc(-10, -45, 4, 0, Math.PI * 2); ctx.fill();
      ctx.beginPath(); ctx.arc(10, -45, 4, 0, Math.PI * 2); ctx.fill();
      // Crazy eyes
      ctx.fillStyle = '#fff';
      ctx.beginPath(); ctx.ellipse(-5, -20, 5, 6, 0, 0, Math.PI * 2); ctx.fill();
      ctx.beginPath(); ctx.ellipse(5, -20, 5, 6, 0, 0, Math.PI * 2); ctx.fill();
      ctx.fillStyle = '#000';
      const eyeOff = Math.sin(Date.now() * 0.005) * 2;
      ctx.beginPath(); ctx.arc(-5 + eyeOff, -20, 2.5, 0, Math.PI * 2); ctx.fill();
      ctx.beginPath(); ctx.arc(5 + eyeOff, -20, 2.5, 0, Math.PI * 2); ctx.fill();
      // Big grin
      ctx.fillStyle = flash ? '#fff' : '#f4a460';
      ctx.beginPath(); ctx.ellipse(2, -10, 10, 5, 0, 0, Math.PI * 2); ctx.fill();
      ctx.strokeStyle = '#000'; ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.arc(2, -12, 8, 0.2, Math.PI - 0.2);
      ctx.stroke();
      break;
      
    case 'Bushroot':
      // Plant body
      ctx.fillStyle = flash ? '#fff' : '#338833';
      // Trunk body
      ctx.beginPath();
      ctx.moveTo(-15, 30); ctx.lineTo(15, 30);
      ctx.quadraticCurveTo(20, 0, 15, -15);
      ctx.quadraticCurveTo(10, -30, 0, -25);
      ctx.quadraticCurveTo(-10, -30, -15, -15);
      ctx.quadraticCurveTo(-20, 0, -15, 30);
      ctx.fill();
      // Leaf crown
      ctx.fillStyle = flash ? '#fff' : '#44aa44';
      for (let i = 0; i < 5; i++) {
        const a = -Math.PI/2 + (i - 2) * 0.4;
        ctx.beginPath();
        ctx.ellipse(Math.cos(a) * 12, -25 + Math.sin(a) * 8, 10, 5, a, 0, Math.PI * 2);
        ctx.fill();
      }
      // Face
      ctx.fillStyle = '#ff4444';
      ctx.beginPath(); ctx.arc(-6, -15, 4, 0, Math.PI * 2); ctx.fill();
      ctx.beginPath(); ctx.arc(6, -15, 4, 0, Math.PI * 2); ctx.fill();
      ctx.strokeStyle = flash ? '#fff' : '#225522';
      ctx.lineWidth = 2;
      ctx.beginPath(); ctx.arc(0, -8, 6, 0.2, Math.PI - 0.2); ctx.stroke();
      // Root legs
      ctx.strokeStyle = flash ? '#fff' : '#336633';
      ctx.lineWidth = 5;
      const rootWave = Math.sin(Date.now() * 0.003);
      ctx.beginPath(); ctx.moveTo(-10, 30); ctx.quadraticCurveTo(-15 + rootWave * 5, 40, -20, 35); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(10, 30); ctx.quadraticCurveTo(15 - rootWave * 5, 40, 20, 35); ctx.stroke();
      break;
      
    case 'Liquidator':
      // Water body
      const wave = Math.sin(Date.now() * 0.005);
      ctx.fillStyle = flash ? '#fff' : 'rgba(68,170,255,0.8)';
      ctx.beginPath();
      ctx.moveTo(-18, 30);
      for (let i = 0; i <= 36; i++) {
        const wx = -18 + i;
        const wy = 30 - (36 - Math.abs(i - 18)) * 1.8 + Math.sin(Date.now() * 0.008 + i * 0.3) * 2;
        ctx.lineTo(wx, wy);
      }
      ctx.closePath(); ctx.fill();
      // Head
      ctx.fillStyle = flash ? '#fff' : 'rgba(68,170,255,0.9)';
      ctx.beginPath(); ctx.arc(0, -18, 16, 0, Math.PI * 2); ctx.fill();
      // Face
      ctx.fillStyle = '#fff';
      ctx.beginPath(); ctx.ellipse(-5, -20, 4, 5, 0, 0, Math.PI * 2); ctx.fill();
      ctx.beginPath(); ctx.ellipse(5, -20, 4, 5, 0, 0, Math.PI * 2); ctx.fill();
      ctx.fillStyle = '#003366';
      ctx.beginPath(); ctx.arc(-5, -20, 2, 0, Math.PI * 2); ctx.fill();
      ctx.beginPath(); ctx.arc(5, -20, 2, 0, Math.PI * 2); ctx.fill();
      // Mouth
      ctx.strokeStyle = '#003366'; ctx.lineWidth = 2;
      ctx.beginPath(); ctx.arc(0, -12, 8, 0.3, Math.PI - 0.3); ctx.stroke();
      // Water drips
      if (!flash) {
        ctx.fillStyle = 'rgba(68,170,255,0.5)';
        for (let i = 0; i < 3; i++) {
          const dy = (Date.now() * 0.02 + i * 50) % 30;
          ctx.beginPath(); ctx.arc(-12 + i * 12, 10 + dy, 2, 0, Math.PI * 2); ctx.fill();
        }
      }
      break;
      
    case 'Negaduck':
      // Dark mirror of Darkwing
      // Cape - red/black
      ctx.fillStyle = flash ? '#fff' : '#880000';
      ctx.beginPath();
      const ncWave = Math.sin(Date.now() * 0.005) * 4;
      ctx.moveTo(-12, -15);
      ctx.quadraticCurveTo(-30, 5 + ncWave, -25, 35);
      ctx.lineTo(25, 35);
      ctx.quadraticCurveTo(30, 5 - ncWave, 12, -15);
      ctx.fill();
      // Body - yellow/red
      ctx.fillStyle = flash ? '#fff' : '#cc2222';
      ctx.fillRect(-15, -8, 30, 35);
      ctx.fillStyle = flash ? '#fff' : '#ffcc00';
      ctx.fillRect(-15, -8, 30, 10);
      // Head
      ctx.fillStyle = flash ? '#fff' : '#f5deb3';
      ctx.beginPath(); ctx.arc(0, -18, 15, 0, Math.PI * 2); ctx.fill();
      // Negaduck hat - red/yellow
      ctx.fillStyle = flash ? '#fff' : '#cc2222';
      ctx.beginPath(); ctx.ellipse(0, -30, 17, 6, 0, 0, Math.PI * 2); ctx.fill();
      ctx.fillRect(-8, -40, 16, 12);
      // Mask
      ctx.fillStyle = flash ? '#fff' : '#cc2222';
      ctx.fillRect(-16, -24, 32, 8);
      // Evil eyes
      ctx.fillStyle = '#fff';
      ctx.beginPath(); ctx.ellipse(-5, -18, 4, 4, 0, 0, Math.PI * 2); ctx.fill();
      ctx.beginPath(); ctx.ellipse(5, -18, 4, 4, 0, 0, Math.PI * 2); ctx.fill();
      ctx.fillStyle = '#ff0000';
      ctx.beginPath(); ctx.arc(-4, -18, 2, 0, Math.PI * 2); ctx.fill();
      ctx.beginPath(); ctx.arc(6, -18, 2, 0, Math.PI * 2); ctx.fill();
      // Angry brow
      ctx.strokeStyle = flash ? '#fff' : '#cc2222';
      ctx.lineWidth = 3;
      ctx.beginPath(); ctx.moveTo(-10, -24); ctx.lineTo(-2, -22); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(10, -24); ctx.lineTo(2, -22); ctx.stroke();
      // Bill
      ctx.fillStyle = flash ? '#fff' : '#f4a460';
      ctx.beginPath(); ctx.ellipse(2, -12, 10, 5, 0, 0, Math.PI * 2); ctx.fill();
      // Sneering mouth
      ctx.strokeStyle = '#000'; ctx.lineWidth = 1.5;
      ctx.beginPath(); ctx.arc(2, -13, 6, 0.5, Math.PI - 0.5); ctx.stroke();
      // Legs
      ctx.fillStyle = flash ? '#fff' : '#aa1111';
      ctx.fillRect(-10, 24, 8, 12);
      ctx.fillRect(2, 24, 8, 12);
      // Chainsaw in phase 3
      if (boss.phase >= 3) {
        ctx.fillStyle = '#888';
        ctx.fillRect(15, -8, 25, 6);
        ctx.fillStyle = '#aaa';
        ctx.fillRect(35, -10, 6, 10);
        // Teeth
        ctx.fillStyle = '#ccc';
        for (let i = 0; i < 5; i++) {
          ctx.fillRect(17 + i * 5, -10, 2, 3);
          ctx.fillRect(17 + i * 5, 0, 2, 3);
        }
      }
      break;
  }
  
  ctx.shadowBlur = 0;
  ctx.restore();
  
  // Boss HP bar (top of screen)
  if (!boss.dead) {
    const barW = 400;
    const barX = (canvas.width - barW) / 2;
    const barY = 20;
    
    // Background
    ctx.fillStyle = 'rgba(0,0,0,0.7)';
    ctx.fillRect(barX - 5, barY - 5, barW + 10, 30);
    
    // Name
    ctx.fillStyle = boss.color;
    ctx.font = 'bold 14px "Segoe UI"';
    ctx.textAlign = 'center';
    ctx.fillText(boss.name, canvas.width / 2, barY + 7);
    
    // Bar
    ctx.fillStyle = '#333';
    ctx.fillRect(barX, barY + 12, barW, 8);
    
    const hpPct = Math.max(0, boss.hp / boss.maxHP);
    const grad = ctx.createLinearGradient(barX, 0, barX + barW * hpPct, 0);
    grad.addColorStop(0, boss.color);
    grad.addColorStop(1, '#ff4444');
    ctx.fillStyle = grad;
    ctx.fillRect(barX, barY + 12, barW * hpPct, 8);
    
    // Phase indicator
    ctx.fillStyle = '#fff';
    ctx.font = '10px "Segoe UI"';
    ctx.fillText(`Phase ${boss.phase}`, canvas.width / 2, barY + 28);
  }
}

// ---------- BACKGROUND RENDERING ----------
function drawBackground(lvl, camX) {
  const bg = lvl.bg;
  
  // Sky gradient
  const skyGrad = ctx.createLinearGradient(0, 0, 0, canvas.height);
  skyGrad.addColorStop(0, bg.sky);
  skyGrad.addColorStop(1, bg.color1);
  ctx.fillStyle = skyGrad;
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  
  // Stars
  if (bg.stars) {
    ctx.fillStyle = '#ffffff';
    for (let i = 0; i < 80; i++) {
      const sx = ((i * 137 + 50) % 2000 - camX * 0.1) % canvas.width;
      const sy = (i * 73 + 30) % (canvas.height * 0.6);
      const twinkle = Math.sin(Date.now() * 0.002 + i) * 0.5 + 0.5;
      ctx.globalAlpha = twinkle * 0.8;
      ctx.fillRect(sx < 0 ? sx + canvas.width : sx, sy, 2, 2);
    }
    ctx.globalAlpha = 1;
    
    // Moon
    ctx.fillStyle = '#ffffdd';
    ctx.beginPath();
    ctx.arc(canvas.width * 0.8 - camX * 0.03, 80, 30, 0, Math.PI * 2);
    ctx.fill();
    ctx.fillStyle = bg.sky;
    ctx.beginPath();
    ctx.arc(canvas.width * 0.8 - camX * 0.03 - 8, 75, 28, 0, Math.PI * 2);
    ctx.fill();
  }
  
  // Buildings (parallax)
  if (bg.buildings) {
    for (let layer = 0; layer < 3; layer++) {
      const parallax = 0.15 + layer * 0.1;
      const alpha = 0.3 + layer * 0.2;
      const baseH = 100 + layer * 80;
      ctx.fillStyle = `rgba(20,20,40,${alpha})`;
      
      for (let i = -1; i < 30; i++) {
        const bx = i * 120 - (camX * parallax) % 120;
        const bh = baseH + Math.sin(i * 2.7) * 50;
        ctx.fillRect(bx, canvas.height - bh, 80, bh);
        
        // Windows
        if (layer === 2) {
          ctx.fillStyle = '#ffdd6633';
          for (let wy = canvas.height - bh + 15; wy < canvas.height - 20; wy += 20) {
            for (let wx = bx + 10; wx < bx + 70; wx += 15) {
              if (Math.sin(wx * 3 + wy * 7) > 0.2) {
                ctx.fillRect(wx, wy, 6, 8);
              }
            }
          }
          ctx.fillStyle = `rgba(20,20,40,${alpha})`;
        }
      }
    }
  }
  
  // Custom backgrounds
  if (bg.custom === 'funhouse') {
    // Colorful stripes in background
    for (let i = 0; i < 20; i++) {
      const sx = i * 150 - (camX * 0.2) % 150;
      ctx.fillStyle = `hsla(${i * 30}, 70%, 30%, 0.15)`;
      ctx.fillRect(sx, 0, 80, canvas.height);
    }
    // Floating balloons
    for (let i = 0; i < 10; i++) {
      const bx = ((i * 200 + 100) - camX * 0.15) % (canvas.width + 200) - 100;
      const by = 100 + Math.sin(Date.now() * 0.001 + i) * 30;
      ctx.fillStyle = `hsl(${i * 40}, 80%, 60%)`;
      ctx.beginPath(); ctx.arc(bx, by, 12, 0, Math.PI * 2); ctx.fill();
      ctx.strokeStyle = '#666'; ctx.lineWidth = 1;
      ctx.beginPath(); ctx.moveTo(bx, by + 12); ctx.lineTo(bx, by + 40); ctx.stroke();
    }
  } else if (bg.custom === 'greenhouse') {
    // Vines hanging from top
    ctx.strokeStyle = '#1a4a1a';
    ctx.lineWidth = 3;
    for (let i = 0; i < 25; i++) {
      const vx = i * 100 - (camX * 0.2) % 100;
      const len = 60 + Math.sin(i * 1.5) * 30;
      ctx.beginPath(); ctx.moveTo(vx, 0);
      ctx.quadraticCurveTo(vx + Math.sin(Date.now() * 0.002 + i) * 15, len * 0.5, vx, len);
      ctx.stroke();
      // Leaves
      ctx.fillStyle = '#2a6a2a';
      ctx.beginPath(); ctx.ellipse(vx + 5, len * 0.3, 8, 4, 0.5, 0, Math.PI * 2); ctx.fill();
    }
  } else if (bg.custom === 'water') {
    // Water reflections at bottom
    ctx.fillStyle = 'rgba(30,60,120,0.3)';
    ctx.fillRect(0, canvas.height - 80, canvas.width, 80);
    for (let i = 0; i < 30; i++) {
      const wx = i * 60 - (camX * 0.3 + Date.now() * 0.02) % 60;
      ctx.strokeStyle = 'rgba(100,180,255,0.15)';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(wx, canvas.height - 70 + Math.sin(Date.now() * 0.003 + i) * 5);
      ctx.lineTo(wx + 40, canvas.height - 70 + Math.sin(Date.now() * 0.003 + i + 1) * 5);
      ctx.stroke();
    }
  } else if (bg.custom === 'fortress') {
    // Dark fortress walls
    ctx.fillStyle = 'rgba(40,15,15,0.5)';
    for (let i = 0; i < 15; i++) {
      const fx = i * 200 - (camX * 0.15) % 200;
      ctx.fillRect(fx, 100, 150, canvas.height);
      // Skull decorations
      ctx.fillStyle = 'rgba(80,30,30,0.3)';
      ctx.beginPath(); ctx.arc(fx + 75, 180, 15, 0, Math.PI * 2); ctx.fill();
      ctx.fillStyle = 'rgba(40,15,15,0.5)';
    }
    // Lava glow at bottom
    const lavaGrad = ctx.createLinearGradient(0, canvas.height - 40, 0, canvas.height);
    lavaGrad.addColorStop(0, 'rgba(255,50,0,0)');
    lavaGrad.addColorStop(1, 'rgba(255,50,0,0.15)');
    ctx.fillStyle = lavaGrad;
    ctx.fillRect(0, canvas.height - 40, canvas.width, 40);
  }
}

// ---------- PLATFORM RENDERING ----------
function drawPlatform(p, camX, camY, color, accent) {
  const x = p.x - camX, y = p.y - camY;
  if (x + p.w < -50 || x > canvas.width + 50) return;
  
  // Main platform
  const grad = ctx.createLinearGradient(x, y, x, y + p.h);
  grad.addColorStop(0, accent);
  grad.addColorStop(1, color);
  ctx.fillStyle = grad;
  
  if (p.h > 25) {
    // Ground block
    ctx.fillRect(x, y, p.w, p.h);
    // Top edge highlight
    ctx.fillStyle = accent;
    ctx.fillRect(x, y, p.w, 3);
  } else {
    // Floating platform with rounded edges
    ctx.beginPath();
    ctx.roundRect(x, y, p.w, p.h, 4);
    ctx.fill();
    // Top highlight
    ctx.fillStyle = accent;
    ctx.fillRect(x + 2, y, p.w - 4, 3);
  }
  
  // Edge shadows
  ctx.fillStyle = 'rgba(0,0,0,0.2)';
  ctx.fillRect(x, y + p.h - 3, p.w, 3);
}

// ---------- UI RENDERING ----------
function drawUI() {
  // HP bar
  const hpBarW = 200;
  const hpBarH = 16;
  const hpX = 20, hpY = canvas.height - 50;
  
  ctx.fillStyle = 'rgba(0,0,0,0.6)';
  ctx.fillRect(hpX - 2, hpY - 20, hpBarW + 60, 55);
  
  ctx.fillStyle = '#fff';
  ctx.font = 'bold 12px "Segoe UI"';
  ctx.textAlign = 'left';
  ctx.fillText('HP', hpX, hpY - 5);
  
  ctx.fillStyle = '#333';
  ctx.fillRect(hpX, hpY, hpBarW, hpBarH);
  
  const hpPct = player.hp / playerStats.maxHP;
  const hpGrad = ctx.createLinearGradient(hpX, 0, hpX + hpBarW * hpPct, 0);
  hpGrad.addColorStop(0, hpPct > 0.5 ? '#44ff44' : hpPct > 0.25 ? '#ffaa00' : '#ff4444');
  hpGrad.addColorStop(1, hpPct > 0.5 ? '#22cc22' : hpPct > 0.25 ? '#cc7700' : '#cc0000');
  ctx.fillStyle = hpGrad;
  ctx.fillRect(hpX, hpY, hpBarW * hpPct, hpBarH);
  
  ctx.fillStyle = '#fff';
  ctx.font = '11px "Segoe UI"';
  ctx.fillText(`${Math.ceil(player.hp)} / ${playerStats.maxHP}`, hpX + 5, hpY + 12);
  
  // Lives
  ctx.fillText(`Lives: ${'ü¶Ü'.repeat(playerStats.lives)}`, hpX, hpY + 32);
  
  // Shield indicator
  if (player.shield > 0) {
    ctx.fillStyle = '#4488ff';
    ctx.fillText(`üõ°Ô∏è Shield: ${Math.ceil(player.shield / 60)}s`, hpX + hpBarW + 10, hpY + 12);
  }
  
  // Ability cooldowns
  const abX = canvas.width - 260;
  const abY = canvas.height - 60;
  ctx.fillStyle = 'rgba(0,0,0,0.6)';
  ctx.fillRect(abX - 10, abY - 15, 270, 55);
  
  abilities.forEach((ab, i) => {
    const ax = abX + i * 62;
    const ready = ab.timer <= 0;
    const pct = ready ? 1 : 1 - (ab.timer / (ab.cooldown * playerStats.cooldownMult));
    
    // Background
    ctx.fillStyle = ready ? ab.color + '44' : '#222';
    ctx.fillRect(ax, abY, 50, 35);
    
    // Cooldown fill
    if (!ready) {
      ctx.fillStyle = ab.color + '33';
      ctx.fillRect(ax, abY + 35 * (1 - pct), 50, 35 * pct);
    }
    
    // Border
    ctx.strokeStyle = ready ? ab.color : '#444';
    ctx.lineWidth = ready ? 2 : 1;
    ctx.strokeRect(ax, abY, 50, 35);
    
    // Icon & key
    ctx.fillStyle = ready ? '#fff' : '#666';
    ctx.font = '16px "Segoe UI"';
    ctx.textAlign = 'center';
    ctx.fillText(ab.icon, ax + 25, abY + 18);
    ctx.font = '9px "Segoe UI"';
    ctx.fillText(`[${ab.key}]`, ax + 25, abY + 31);
  });
  ctx.textAlign = 'left';
  
  // Level info
  ctx.fillStyle = 'rgba(0,0,0,0.5)';
  ctx.fillRect(canvas.width/2 - 100, canvas.height - 30, 200, 25);
  ctx.fillStyle = '#ccc';
  ctx.font = '12px "Segoe UI"';
  ctx.textAlign = 'center';
  ctx.fillText(`Level ${playerStats.currentLevel + 1}: ${LEVELS[playerStats.currentLevel].name}`, canvas.width/2, canvas.height - 13);
  ctx.textAlign = 'left';
}

// ---------- TITLE SCREEN ----------
function drawTitle() {
  // Animated gradient background
  const t = Date.now() * 0.001;
  const grad = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
  grad.addColorStop(0, '#0c0c2e');
  grad.addColorStop(0.5, '#1a0a3a');
  grad.addColorStop(1, '#0c0c2e');
  ctx.fillStyle = grad;
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  
  // Stars
  for (let i = 0; i < 100; i++) {
    const sx = (i * 137 + Date.now() * 0.01) % canvas.width;
    const sy = (i * 73) % canvas.height;
    ctx.globalAlpha = Math.sin(t * 2 + i) * 0.3 + 0.5;
    ctx.fillStyle = '#fff';
    ctx.fillRect(sx, sy, 2, 2);
  }
  ctx.globalAlpha = 1;
  
  // Spotlight effect
  const spotGrad = ctx.createRadialGradient(canvas.width/2, canvas.height * 0.35, 0, canvas.width/2, canvas.height * 0.35, 300);
  spotGrad.addColorStop(0, 'rgba(123,47,247,0.15)');
  spotGrad.addColorStop(1, 'rgba(0,0,0,0)');
  ctx.fillStyle = spotGrad;
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  
  // Title
  ctx.textAlign = 'center';
  
  // Shadow
  ctx.fillStyle = 'rgba(0,0,0,0.5)';
  ctx.font = 'bold 64px "Segoe UI"';
  ctx.fillText('DARKWING DUCK', canvas.width/2 + 3, canvas.height * 0.28 + 3);
  
  // Main title with gradient
  const titleGrad = ctx.createLinearGradient(canvas.width/2 - 200, 0, canvas.width/2 + 200, 0);
  titleGrad.addColorStop(0, '#7b2ff7');
  titleGrad.addColorStop(0.5, '#c471f5');
  titleGrad.addColorStop(1, '#7b2ff7');
  ctx.fillStyle = titleGrad;
  ctx.font = 'bold 64px "Segoe UI"';
  ctx.fillText('DARKWING DUCK', canvas.width/2, canvas.height * 0.28);
  
  // Subtitle
  ctx.fillStyle = '#ff8844';
  ctx.font = 'italic 28px "Segoe UI"';
  ctx.fillText("Let's Get Dangerous!", canvas.width/2, canvas.height * 0.36);
  
  // Darkwing silhouette
  const cx = canvas.width / 2;
  const cy = canvas.height * 0.52;
  drawDarkwing(cx, cy, 1, Math.floor(t * 5) % 40, false, 0, 0, 0);
  
  // Instructions
  const blink = Math.sin(t * 3) > 0;
  if (blink) {
    ctx.fillStyle = '#ffffff';
    ctx.font = 'bold 22px "Segoe UI"';
    ctx.fillText('CLICK TO START', canvas.width/2, canvas.height * 0.72);
  }
  
  // Controls
  ctx.fillStyle = '#8888aa';
  ctx.font = '14px "Segoe UI"';
  ctx.fillText('Arrow Keys / WASD ‚Äî Move & Jump  |  Click ‚Äî Shoot  |  1-4 ‚Äî Special Abilities', canvas.width/2, canvas.height * 0.82);
  ctx.fillText('Defeat all 5 bosses to save St. Canard!', canvas.width/2, canvas.height * 0.87);
  
  // Credits
  ctx.fillStyle = '#555';
  ctx.font = '11px "Segoe UI"';
  ctx.fillText('A fan tribute to Disney\'s Darkwing Duck', canvas.width/2, canvas.height * 0.95);
  
  ctx.textAlign = 'left';
  
  if (mouse.clicked) {
    ensureAudio();
    playSound('select');
    playerStats.lives = 3;
    playerStats.maxHP = 100;
    playerStats.damage = 15;
    playerStats.speed = 4.5;
    playerStats.cooldownMult = 1.0;
    playerStats.level = 1;
    abilities.forEach(a => a.timer = 0);
    loadLevel(0);
  }
}

// ---------- LEVEL INTRO SCREEN ----------
function drawLevelIntro() {
  stateTimer++;
  const lvl = LEVELS[playerStats.currentLevel];
  
  // Dark overlay
  ctx.fillStyle = 'rgba(0,0,0,0.85)';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  
  ctx.textAlign = 'center';
  
  // Level number
  const slideIn = Math.min(1, stateTimer / 30);
  ctx.globalAlpha = slideIn;
  ctx.fillStyle = '#666';
  ctx.font = 'bold 20px "Segoe UI"';
  ctx.fillText(`LEVEL ${playerStats.currentLevel + 1}`, canvas.width/2, canvas.height * 0.35);
  
  // Level name
  ctx.fillStyle = LEVELS[playerStats.currentLevel].bossColor;
  ctx.font = 'bold 42px "Segoe UI"';
  ctx.fillText(lvl.name, canvas.width/2, canvas.height * 0.45);
  
  // Subtitle
  ctx.fillStyle = '#aaa';
  ctx.font = 'italic 20px "Segoe UI"';
  ctx.fillText(lvl.subtitle, canvas.width/2, canvas.height * 0.53);
  
  // Boss preview
  if (stateTimer > 40) {
    ctx.fillStyle = '#ff4444';
    ctx.font = '16px "Segoe UI"';
    ctx.fillText(`Boss: ${lvl.bossName}`, canvas.width/2, canvas.height * 0.65);
  }
  
  ctx.globalAlpha = 1;
  ctx.textAlign = 'left';
  
  if (stateTimer > 120 || (stateTimer > 30 && mouse.clicked)) {
    state = GameState.PLAYING;
  }
}

// ---------- BOSS INTRO ----------
function drawBossIntro() {
  stateTimer++;
  
  ctx.fillStyle = 'rgba(0,0,0,0.7)';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  
  ctx.textAlign = 'center';
  
  const slideIn = Math.min(1, stateTimer / 20);
  ctx.globalAlpha = slideIn;
  
  // Warning
  if (stateTimer % 30 < 15) {
    ctx.fillStyle = '#ff4444';
    ctx.font = 'bold 30px "Segoe UI"';
    ctx.fillText('‚ö† WARNING ‚ö†', canvas.width/2, canvas.height * 0.35);
  }
  
  // Boss name
  ctx.fillStyle = boss.color;
  ctx.font = 'bold 48px "Segoe UI"';
  ctx.fillText(boss.name.toUpperCase(), canvas.width/2, canvas.height * 0.5);
  
  ctx.fillStyle = '#ccc';
  ctx.font = '18px "Segoe UI"';
  ctx.fillText('has appeared!', canvas.width/2, canvas.height * 0.58);
  
  ctx.globalAlpha = 1;
  ctx.textAlign = 'left';
  
  if (stateTimer > 90) {
    state = GameState.PLAYING;
    bossActive = true;
  }
}

// ---------- UPGRADE SCREEN ----------
let upgradeSelection = 0;
const upgradeOptions = [
  { name: 'Max HP +20', desc: 'Increase maximum health', icon: '‚ù§Ô∏è', apply() { playerStats.maxHP += 20; } },
  { name: 'Damage +5', desc: 'Stronger gas gun', icon: 'üí•', apply() { playerStats.damage += 5; } },
  { name: 'Speed +0.5', desc: 'Move faster', icon: '‚ö°', apply() { playerStats.speed += 0.5; } },
  { name: 'Cooldown -10%', desc: 'Faster ability recharge', icon: 'üîÑ', apply() { playerStats.cooldownMult *= 0.9; } }
];

function drawUpgrade() {
  stateTimer++;
  
  ctx.fillStyle = 'rgba(0,0,15,0.95)';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  
  ctx.textAlign = 'center';
  
  // Title
  ctx.fillStyle = '#ffcc00';
  ctx.font = 'bold 36px "Segoe UI"';
  ctx.fillText('LEVEL COMPLETE!', canvas.width/2, canvas.height * 0.15);
  
  ctx.fillStyle = '#aaa';
  ctx.font = '18px "Segoe UI"';
  ctx.fillText(`${LEVELS[playerStats.currentLevel].bossName} defeated!`, canvas.width/2, canvas.height * 0.22);
  
  // Current stats
  ctx.fillStyle = '#888';
  ctx.font = '14px "Segoe UI"';
  ctx.fillText(`HP: ${playerStats.maxHP} | DMG: ${playerStats.damage} | SPD: ${playerStats.speed.toFixed(1)} | CD: ${Math.round((1-playerStats.cooldownMult)*100)}% reduction`, canvas.width/2, canvas.height * 0.3);
  
  // Upgrade options
  ctx.fillStyle = '#fff';
  ctx.font = 'bold 22px "Segoe UI"';
  ctx.fillText('Choose an upgrade:', canvas.width/2, canvas.height * 0.4);
  
  const optW = 160, optH = 120, gap = 20;
  const startX = canvas.width/2 - (upgradeOptions.length * (optW + gap) - gap) / 2;
  
  upgradeOptions.forEach((opt, i) => {
    const ox = startX + i * (optW + gap);
    const oy = canvas.height * 0.45;
    
    // Check mouse hover
    if (mouse.x > ox && mouse.x < ox + optW && mouse.y > oy && mouse.y < oy + optH) {
      upgradeSelection = i;
    }
    
    const selected = i === upgradeSelection;
    
    // Box
    ctx.fillStyle = selected ? 'rgba(123,47,247,0.3)' : 'rgba(40,40,60,0.8)';
    ctx.fillRect(ox, oy, optW, optH);
    ctx.strokeStyle = selected ? '#7b2ff7' : '#444';
    ctx.lineWidth = selected ? 3 : 1;
    ctx.strokeRect(ox, oy, optW, optH);
    
    // Icon
    ctx.font = '30px "Segoe UI"';
    ctx.fillStyle = '#fff';
    ctx.fillText(opt.icon, ox + optW/2, oy + 35);
    
    // Name
    ctx.font = 'bold 14px "Segoe UI"';
    ctx.fillStyle = selected ? '#fff' : '#aaa';
    ctx.fillText(opt.name, ox + optW/2, oy + 65);
    
    // Desc
    ctx.font = '11px "Segoe UI"';
    ctx.fillStyle = '#888';
    ctx.fillText(opt.desc, ox + optW/2, oy + 85);
    
    // Key hint
    ctx.font = '10px "Segoe UI"';
    ctx.fillStyle = '#666';
    ctx.fillText(`[${i + 1}]`, ox + optW/2, oy + 105);
  });
  
  ctx.textAlign = 'left';
  
  // Input
  if (keys['Digit1']) { upgradeSelection = 0; confirmUpgrade(); }
  if (keys['Digit2']) { upgradeSelection = 1; confirmUpgrade(); }
  if (keys['Digit3']) { upgradeSelection = 2; confirmUpgrade(); }
  if (keys['Digit4']) { upgradeSelection = 3; confirmUpgrade(); }
  if (mouse.clicked) {
    const startXc = canvas.width/2 - (upgradeOptions.length * (optW + gap) - gap) / 2;
    upgradeOptions.forEach((opt, i) => {
      const ox = startXc + i * (optW + gap);
      const oy = canvas.height * 0.45;
      if (mouse.x > ox && mouse.x < ox + optW && mouse.y > oy && mouse.y < oy + optH) {
        upgradeSelection = i;
        confirmUpgrade();
      }
    });
  }
}

function confirmUpgrade() {
  upgradeOptions[upgradeSelection].apply();
  playerStats.level++;
  playSound('powerup');
  loadLevel(playerStats.currentLevel + 1);
}

// ---------- GAME OVER SCREEN ----------
function drawGameOver() {
  stateTimer++;
  ctx.fillStyle = 'rgba(10,0,0,0.9)';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  
  ctx.textAlign = 'center';
  
  ctx.fillStyle = '#ff4444';
  ctx.font = 'bold 48px "Segoe UI"';
  ctx.fillText('GAME OVER', canvas.width/2, canvas.height * 0.4);
  
  ctx.fillStyle = '#888';
  ctx.font = '20px "Segoe UI"';
  ctx.fillText(`Reached Level ${playerStats.currentLevel + 1}: ${LEVELS[playerStats.currentLevel].name}`, canvas.width/2, canvas.height * 0.5);
  
  if (stateTimer > 60) {
    const blink = Math.sin(Date.now() * 0.005) > 0;
    if (blink) {
      ctx.fillStyle = '#fff';
      ctx.font = 'bold 20px "Segoe UI"';
      ctx.fillText('Click to try again', canvas.width/2, canvas.height * 0.65);
    }
    if (mouse.clicked) { state = GameState.TITLE; stateTimer = 0; }
  }
  ctx.textAlign = 'left';
}

// ---------- WIN SCREEN ----------
function drawWin() {
  stateTimer++;
  
  const t = Date.now() * 0.001;
  ctx.fillStyle = '#0a0a2e';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  
  // Fireworks
  if (stateTimer % 15 === 0) {
    const fx = Math.random() * canvas.width;
    const fy = Math.random() * canvas.height * 0.5;
    const colors = ['#ff4444', '#44ff44', '#4444ff', '#ffff44', '#ff44ff', '#44ffff', '#ff8844'];
    spawnParticles(fx, fy, 30, colors[Math.floor(Math.random() * colors.length)], 5, 40, 4, 'spark');
    if (stateTimer % 30 === 0) playSound('explosion');
  }
  
  // Draw particles on screen (no camera offset for this)
  particles.forEach(p => {
    const a = p.life / p.maxLife;
    ctx.globalAlpha = a;
    ctx.fillStyle = p.color;
    ctx.beginPath(); ctx.arc(p.x, p.y, p.size * a, 0, Math.PI * 2); ctx.fill();
  });
  ctx.globalAlpha = 1;
  
  ctx.textAlign = 'center';
  
  ctx.fillStyle = '#ffcc00';
  ctx.font = 'bold 52px "Segoe UI"';
  ctx.fillText('VICTORY!', canvas.width/2, canvas.height * 0.3);
  
  ctx.fillStyle = '#c471f5';
  ctx.font = 'bold 24px "Segoe UI"';
  ctx.fillText('St. Canard is saved!', canvas.width/2, canvas.height * 0.4);
  
  ctx.fillStyle = '#aaa';
  ctx.font = '18px "Segoe UI"';
  ctx.fillText(`Final Stats: HP ${playerStats.maxHP} | DMG ${playerStats.damage} | SPD ${playerStats.speed.toFixed(1)}`, canvas.width/2, canvas.height * 0.52);
  ctx.fillText(`Player Level: ${playerStats.level}`, canvas.width/2, canvas.height * 0.57);
  
  // Darkwing
  drawDarkwing(canvas.width/2, canvas.height * 0.7, 1, Math.floor(t * 5) % 40, false, 0, 0, 0);
  
  if (stateTimer > 60) {
    const blink = Math.sin(t * 3) > 0;
    if (blink) {
      ctx.fillStyle = '#fff';
      ctx.font = 'bold 20px "Segoe UI"';
      ctx.fillText('Click to play again', canvas.width/2, canvas.height * 0.85);
    }
    if (mouse.clicked) { state = GameState.TITLE; stateTimer = 0; }
  }
  ctx.textAlign = 'left';
}

// ---------- MAIN UPDATE ----------
function updatePlaying() {
  if (!player || player.dead) return;
  
  const spd = playerStats.speed + (player.speedBoost > 0 ? 3 : 0);
  
  // Horizontal movement
  let moveX = 0;
  if (keys['ArrowLeft'] || keys['KeyA']) moveX = -1;
  if (keys['ArrowRight'] || keys['KeyD']) moveX = 1;
  player.vx = moveX * spd;
  if (moveX !== 0) player.facing = moveX;
  
  // Jump
  const jumpKey = keys['ArrowUp'] || keys['KeyW'] || keys['Space'];
  if (jumpKey && !player.jumpHeld && (player.grounded || player.coyoteTime > 0)) {
    player.vy = -11;
    player.grounded = false;
    player.coyoteTime = 0;
    player.jumpHeld = true;
    playSound('jump');
  }
  if (!jumpKey) player.jumpHeld = false;
  // Variable jump height
  if (!jumpKey && player.vy < -3) player.vy = -3;
  
  // Gravity
  player.vy += GRAVITY;
  if (player.vy > TERMINAL_VEL) player.vy = TERMINAL_VEL;
  
  // Apply velocity
  player.x += player.vx;
  player.y += player.vy;
  
  // Platform collision
  player.grounded = false;
  for (const p of currentPlatforms) {
    // Top collision (landing)
    if (player.x + 14 > p.x && player.x - 14 < p.x + p.w &&
        player.y + 24 > p.y && player.y + 24 < p.y + p.h + 8 && player.vy >= 0) {
      player.y = p.y - 24;
      player.vy = 0;
      player.grounded = true;
      player.coyoteTime = 6;
    }
    // Side collision
    if (player.y + 20 > p.y && player.y - 20 < p.y + p.h) {
      if (player.x + 14 > p.x && player.x + 14 < p.x + 10 && player.vx > 0) {
        player.x = p.x - 14;
      }
      if (player.x - 14 < p.x + p.w && player.x - 14 > p.x + p.w - 10 && player.vx < 0) {
        player.x = p.x + p.w + 14;
      }
    }
  }
  
  if (!player.grounded && player.coyoteTime > 0) player.coyoteTime--;
  
  // Fall death
  if (player.y > 700) {
    damagePlayer(playerStats.maxHP);
  }
  
  // Keep in bounds
  if (player.x < 16) player.x = 16;
  const lvl = LEVELS[playerStats.currentLevel];
  if (player.x > lvl.length) player.x = lvl.length;
  
  // Shooting
  if (player.shootCooldown > 0) player.shootCooldown--;
  if (mouse.clicked && player.shootCooldown <= 0) {
    player.shooting = true;
    player.shootTimer = 8;
    player.shootCooldown = 12;
    
    const camX = Math.max(0, player.x - canvas.width / 2);
    const camY = Math.max(0, Math.min(player.y - canvas.height / 2, 100));
    const targetX = mouse.x + camX;
    const targetY = mouse.y + camY;
    const angle = Math.atan2(targetY - player.y, targetX - player.x);
    
    bullets.push({
      x: player.x + player.facing * 20,
      y: player.y - 2,
      vx: Math.cos(angle) * 10,
      vy: Math.sin(angle) * 10,
      damage: playerStats.damage,
      life: 60
    });
    playSound('shoot');
    spawnParticles(player.x + player.facing * 25, player.y - 2, 3, '#ff8844', 2, 8, 2, 'spark');
  }
  if (player.shootTimer > 0) player.shootTimer--;
  else player.shooting = false;
  
  // Timers
  if (player.invincible > 0) player.invincible--;
  if (player.speedBoost > 0) {
    player.speedBoost--;
    if (player.speedBoost % 3 === 0) {
      spawnParticles(player.x, player.y + 20, 1, '#44ff88', 1, 10, 2, 'circle');
    }
  }
  if (player.hitTimer > 0) player.hitTimer--;
  
  // Abilities
  abilities.forEach((ab, i) => {
    if (ab.timer > 0) ab.timer--;
    if (keys[`Digit${i + 1}`] && ab.timer <= 0) {
      ab.use(player);
      ab.timer = Math.floor(ab.cooldown * playerStats.cooldownMult);
    }
  });
  
  // Animation
  player.animTimer++;
  if (Math.abs(player.vx) > 0.5) player.animFrame++;
  
  // Update bullets
  bullets = bullets.filter(b => {
    b.x += b.vx; b.y += b.vy; b.life--;
    return b.life > 0;
  });
  
  // Update enemy bullets
  enemyBullets = enemyBullets.filter(b => {
    b.x += b.vx; b.y += b.vy; b.life--;
    if (b.bouncy) {
      b.vy += 0.15;
      // Bounce off platforms
      for (const p of currentPlatforms) {
        if (b.x > p.x && b.x < p.x + p.w && b.y > p.y && b.y < p.y + p.h && b.vy > 0) {
          b.vy = -Math.abs(b.vy) * 0.8;
          b.y = p.y;
        }
      }
    }
    if (b.wave) {
      // Ground wave stays on ground
      b.y = 540;
    }
    if (b.bomb) {
      b.vy += 0.2;
      // Explode on ground
      for (const p of currentPlatforms) {
        if (b.x > p.x && b.x < p.x + p.w && b.y > p.y) {
          spawnParticles(b.x, b.y, 15, '#ff4444', 4, 20, 4, 'circle');
          playSound('explosion');
          shake(5);
          if (Math.abs(player.x - b.x) < 80 && Math.abs(player.y - b.y) < 80) {
            damagePlayer(b.damage);
          }
          b.life = 0;
        }
      }
    }
    // Hit player
    if (Math.abs(b.x - player.x) < 18 && Math.abs(b.y - player.y) < 24) {
      damagePlayer(b.damage);
      b.life = 0;
    }
    return b.life > 0;
  });
  
  // Bullet-enemy collisions
  bullets.forEach(b => {
    enemies.forEach(e => {
      if (!e.active) return;
      if (Math.abs(b.x - e.x) < e.w/2 + 5 && Math.abs(b.y - e.y) < e.h/2 + 5) {
        e.hp -= b.damage;
        e.hitTimer = 8;
        b.life = 0;
        spawnParticles(b.x, b.y, 5, '#ff8844', 3, 10, 2, 'spark');
        playSound('hit');
        if (e.hp <= 0) {
          e.active = false;
          spawnParticles(e.x, e.y, 15, '#ff4400', 4, 25, 4, 'circle');
          playSound('explosion');
        }
      }
    });
    // Bullet-boss collision
    if (boss && !boss.dead && Math.abs(b.x - boss.x) < 30 && Math.abs(b.y - boss.y) < 35) {
      boss.hp -= b.damage;
      boss.hitTimer = 6;
      b.life = 0;
      spawnParticles(b.x, b.y, 5, boss.color, 3, 12, 3, 'spark');
      playSound('hit');
    }
  });
  bullets = bullets.filter(b => b.life > 0);
  
  // Update enemies
  enemies.forEach(e => {
    if (!e.active) return;
    if (e.hitTimer > 0) e.hitTimer--;
    e.animTimer++;
    
    const distToPlayer = Math.abs(e.x - player.x);
    if (distToPlayer > 800) return; // Don't process far enemies
    
    e.facing = player.x < e.x ? -1 : 1;
    
    switch(e.type) {
      case 'goon':
        if (distToPlayer < 400) {
          e.x += e.facing * e.speed;
          e.shootTimer--;
          if (e.shootTimer <= 0) {
            const angle = Math.atan2(player.y - e.y, player.x - e.x);
            enemyBullets.push({ x: e.x, y: e.y, vx: Math.cos(angle) * 4, vy: Math.sin(angle) * 4, damage: e.damage, color: '#ff4444', size: 4, life: 90 });
            e.shootTimer = 100 + Math.random() * 60;
            playSound('shoot');
          }
        }
        // Gravity + platform
        e.vy = (e.vy || 0) + GRAVITY;
        e.y += e.vy;
        for (const p of currentPlatforms) {
          if (e.x + 14 > p.x && e.x - 14 < p.x + p.w && e.y + 20 > p.y && e.y + 20 < p.y + p.h + 5 && e.vy >= 0) {
            e.y = p.y - 20; e.vy = 0;
          }
        }
        break;
      case 'drone':
        e.floatOffset += 0.03;
        e.y = e.baseY + Math.sin(e.floatOffset) * 30;
        if (distToPlayer < 500) e.x += e.facing * e.speed;
        if (e.animTimer % 80 === 0 && distToPlayer < 400) {
          enemyBullets.push({ x: e.x, y: e.y + 10, vx: 0, vy: 4, damage: e.damage, color: '#ff6666', size: 3, life: 60 });
        }
        break;
      case 'toySoldier':
        if (distToPlayer < 350) {
          e.x += e.facing * e.speed;
          e.jumpTimer--;
          if (e.jumpTimer <= 0) {
            e.vy = -8;
            e.jumpTimer = 40 + Math.random() * 40;
          }
        }
        e.vy = (e.vy || 0) + GRAVITY;
        e.y += e.vy;
        for (const p of currentPlatforms) {
          if (e.x + 12 > p.x && e.x - 12 < p.x + p.w && e.y + 18 > p.y && e.y + 18 < p.y + p.h + 5 && e.vy >= 0) {
            e.y = p.y - 18; e.vy = 0;
          }
        }
        break;
      case 'jackbox':
        if (distToPlayer < 200 && !e.popped) {
          e.popped = true;
          e.popTimer = 60;
          playSound('powerup');
        }
        if (e.popped) {
          e.popTimer--;
          if (e.popTimer <= 0) {
            // Damage in area
            if (distToPlayer < 80) damagePlayer(e.damage);
            spawnParticles(e.x, e.y, 10, '#ff66aa', 4, 15, 3, 'circle');
            e.popped = false;
          }
        }
        break;
      case 'vine':
        if (distToPlayer < 300) e.x += e.facing * e.speed;
        e.whipTimer--;
        if (e.whipTimer <= 0 && distToPlayer < 120) {
          if (distToPlayer < 60) damagePlayer(e.damage);
          spawnParticles(e.x + e.facing * 30, e.y, 5, '#44aa44', 3, 10, 3, 'spark');
          e.whipTimer = 70;
        } else if (e.whipTimer <= 0) e.whipTimer = 10;
        e.vy = (e.vy || 0) + GRAVITY;
        e.y += e.vy;
        for (const p of currentPlatforms) {
          if (e.x + 12 > p.x && e.x - 12 < p.x + p.w && e.y + 25 > p.y && e.y + 25 < p.y + p.h + 5 && e.vy >= 0) {
            e.y = p.y - 25; e.vy = 0;
          }
        }
        break;
      case 'spore':
        e.floatOffset += 0.02;
        e.y = e.baseY + Math.sin(e.floatOffset) * 20;
        if (distToPlayer < 300) e.x += e.facing * e.speed;
        e.sporeTimer--;
        if (e.sporeTimer <= 0 && distToPlayer < 300) {
          // Release spore cloud
          for (let i = 0; i < 3; i++) {
            enemyBullets.push({ x: e.x, y: e.y, vx: (Math.random()-0.5)*3, vy: (Math.random()-0.5)*3, damage: e.damage, color: '#88cc44', size: 6, life: 90 });
          }
          e.sporeTimer = 100;
        }
        break;
    }
    
    // Contact damage
    if (Math.abs(player.x - e.x) < (e.w/2 + 14) && Math.abs(player.y - e.y) < (e.h/2 + 20)) {
      damagePlayer(e.damage);
    }
  });
  
  // Trigger boss
  if (!bossActive && !boss && player.x > LEVELS[playerStats.currentLevel].bossX - 400) {
    boss = createBoss(playerStats.currentLevel);
    state = GameState.BOSS_INTRO;
    stateTimer = 0;
    playSound('boss');
  }
  
  // Update boss
  if (bossActive) updateBoss();
  
  // Update particles
  for (let i = particles.length - 1; i >= 0; i--) {
    if (!particles[i].update()) particles.splice(i, 1);
  }
  
  // Screen shake decay
  shakeAmount *= shakeDecay;
  if (shakeAmount < 0.5) shakeAmount = 0;
}

// ---------- MAIN DRAW ----------
function drawPlaying() {
  const lvl = LEVELS[playerStats.currentLevel];
  
  // Camera
  let camX = Math.max(0, player.x - canvas.width / 2);
  let camY = 0;
  
  // Apply shake
  if (shakeAmount > 0) {
    camX += (Math.random() - 0.5) * shakeAmount;
    camY += (Math.random() - 0.5) * shakeAmount;
  }
  
  // Background
  drawBackground(lvl, camX);
  
  // Platforms
  for (const p of currentPlatforms) {
    drawPlatform(p, camX, camY, lvl.platformColor, lvl.platformAccent);
  }
  
  // Enemies
  enemies.forEach(e => drawEnemy(e, camX, camY));
  
  // Player bullets
  bullets.forEach(b => {
    const bx = b.x - camX, by = b.y - camY;
    // Bullet trail
    ctx.fillStyle = 'rgba(255,136,68,0.3)';
    ctx.beginPath(); ctx.arc(bx - b.vx, by - b.vy, 4, 0, Math.PI * 2); ctx.fill();
    // Bullet
    ctx.fillStyle = '#ff8844';
    ctx.beginPath(); ctx.arc(bx, by, 4, 0, Math.PI * 2); ctx.fill();
    ctx.fillStyle = '#ffcc88';
    ctx.beginPath(); ctx.arc(bx, by, 2, 0, Math.PI * 2); ctx.fill();
  });
  
  // Enemy bullets
  enemyBullets.forEach(b => {
    const bx = b.x - camX, by = b.y - camY;
    ctx.fillStyle = b.color || '#ff4444';
    ctx.beginPath(); ctx.arc(bx, by, b.size || 4, 0, Math.PI * 2); ctx.fill();
    ctx.fillStyle = '#ffffff44';
    ctx.beginPath(); ctx.arc(bx, by, (b.size || 4) * 0.5, 0, Math.PI * 2); ctx.fill();
  });
  
  // Player
  drawDarkwing(player.x - camX, player.y - camY, player.facing, player.animFrame,
    player.shooting, player.hitTimer, player.shield, player.invincible);
  
  // Boss
  if (boss) drawBoss(camX, camY);
  
  // Particles
  particles.forEach(p => p.draw(ctx, camX, camY));
  
  // UI
  drawUI();
}

// ---------- MAIN LOOP ----------
function gameLoop() {
  switch(state) {
    case GameState.TITLE:
      drawTitle();
      break;
    case GameState.LEVEL_INTRO:
      drawPlaying();
      drawLevelIntro();
      break;
    case GameState.PLAYING:
      updatePlaying();
      drawPlaying();
      break;
    case GameState.BOSS_INTRO:
      drawPlaying();
      drawBossIntro();
      break;
    case GameState.UPGRADE:
      drawUpgrade();
      break;
    case GameState.GAME_OVER:
      drawGameOver();
      break;
    case GameState.WIN:
      // Still update particles for fireworks
      for (let i = particles.length - 1; i >= 0; i--) {
        if (!particles[i].update()) particles.splice(i, 1);
      }
      drawWin();
      break;
  }
  
  mouse.clicked = false;
  requestAnimationFrame(gameLoop);
}

// ---------- LOADING ----------
document.getElementById('loadBar').style.width = '100%';
setTimeout(() => {
  document.getElementById('loading').style.display = 'none';
  gameLoop();
}, 500);

</script>
</body>
</html>